<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Trading - NabilH</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background-color: #131722; color: #d1d4dc; margin: 0; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        .card { background: #1e222d; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.3); padding: 25px; margin-bottom: 20px; border: 1px solid #2a2e39; }
        h1 { margin: 0 0 16px 0; color: #2962ff; font-size: 24px; border-bottom: 1px solid #2a2e39; padding-bottom: 15px; }

        /* Barre horloges */
        .clock-bar { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; background: #2a2e39; border-radius: 8px; padding: 10px 16px; margin-bottom: 20px; justify-content: space-between; }
        .clock-item { display: flex; flex-direction: column; align-items: center; gap: 2px; }
        .clock-city { font-size: 10px; color: #787b86; text-transform: uppercase; letter-spacing: 1px; }
        .clock-time { font-size: 20px; font-weight: bold; color: #fff; font-variant-numeric: tabular-nums; letter-spacing: 1px; }
        .market-badge { padding: 4px 14px; border-radius: 20px; font-size: 11px; font-weight: bold; letter-spacing: 0.5px; display: flex; align-items: center; gap: 6px; }
        .market-open { background: #00e67622; color: #00e676; border: 1px solid #00e67644; }
        .market-closed { background: #ff525222; color: #ff5252; border: 1px solid #ff525244; }
        .market-prepost { background: #ffb30022; color: #ffb300; border: 1px solid #ffb30044; }
        .market-dot { width: 7px; height: 7px; border-radius: 50%; }
        .market-dot-open { background: #00e676; box-shadow: 0 0 6px #00e676; animation: blink 1.5s infinite; }
        .market-dot-closed { background: #ff5252; }
        .market-dot-prepost { background: #ffb300; animation: blink 2s infinite; }
        @keyframes blink { 0%,100%{opacity:1} 50%{opacity:0.3} }
        .clock-divider { width: 1px; height: 36px; background: #3a3e49; }

        .status-badge { padding: 5px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .status-running { background: #00e676; color: #000; box-shadow: 0 0 10px rgba(0, 230, 118, 0.3); }
        .status-stopped { background: #ff5252; color: #fff; }

        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 25px; }
        .stat-box { background: #2a2e39; padding: 20px; border-radius: 6px; transition: transform 0.2s; }
        .stat-box:hover { transform: translateY(-2px); }
        .stat-label { font-size: 13px; color: #787b86; margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
        .stat-value { font-size: 26px; font-weight: bold; color: #fff; }
        .profit { color: #00e676; }
        .loss { color: #ff5252; }

        h3 { margin: 25px 0 15px 0; color: #d1d4dc; font-size: 18px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 12px; text-align: left; border-bottom: 1px solid #2a2e39; }
        th { color: #787b86; font-weight: 500; font-size: 12px; text-transform: uppercase; }
        td { font-size: 14px; }

        /* Graphique */
        .chart-wrap { position: relative; height: 180px; margin-top: 10px; }
        .chart-tabs { display: flex; gap: 8px; margin-bottom: 10px; }
        .chart-tab { padding: 4px 12px; border-radius: 4px; font-size: 11px; cursor: pointer; border: 1px solid #2a2e39; background: transparent; color: #787b86; transition: all 0.2s; }
        .chart-tab.active { background: #2962ff22; border-color: #2962ff44; color: #2962ff; }

        /* Ordres */
        .order-badge { padding: 2px 8px; border-radius: 3px; font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 0.5px; }
        .order-filled { background: #00e67622; color: #00e676; border: 1px solid #00e67644; }
        .order-partially_filled { background: #ffb30022; color: #ffb300; border: 1px solid #ffb30044; }
        .order-pending_new, .order-new, .order-accepted { background: #2962ff22; color: #2962ff; border: 1px solid #2962ff44; }
        .order-canceled, .order-expired, .order-rejected { background: #ff525222; color: #ff5252; border: 1px solid #ff525244; }
        .side-buy { color: #00e676; font-weight: bold; }
        .side-sell { color: #ff5252; font-weight: bold; }
        @keyframes newOrder { 0%,100%{background:transparent} 50%{background:rgba(41,98,255,0.08)} }
        .order-new-row { animation: newOrder 1.5s ease-in-out 3; }

        /* ===================== CERVEAU ANIM√â ===================== */
        .ai-box { background: #1a1f35; border: 1px solid #2962ff44; border-radius: 8px; padding: 16px 20px; margin-top: 20px; }
        .ai-inner { display: flex; align-items: flex-start; gap: 20px; }
        .ai-brain-wrap { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 6px; }

        .brain-svg { width: 64px; height: 64px; }

        /* Couleur de base : gris bleut√© */
        .brain-idle .brain-fill { fill: #2a3560; transition: fill 1s ease; }
        .brain-idle .brain-pulse { fill: none; stroke: #2962ff; stroke-width: 1; opacity: 0.3; }

        /* Thinking : orange vif pulsant */
        .brain-thinking .brain-fill { fill: #ff6d00; transition: fill 0.3s ease; }
        .brain-thinking .brain-pulse { fill: none; stroke: #ff6d00; stroke-width: 2; animation: brainPulse 0.8s ease-in-out infinite; }

        /* Done : vert */
        .brain-done .brain-fill { fill: #00695c; transition: fill 0.5s ease; }
        .brain-done .brain-pulse { fill: none; stroke: #00e676; stroke-width: 1.5; animation: brainPulse 2s ease-in-out infinite; }

        @keyframes brainPulse { 0%,100%{opacity:0.2; transform:scale(1)} 50%{opacity:0.9; transform:scale(1.15)} }

        /* Ondes rayonnantes autour du cerveau */
        .brain-wave { position: absolute; border-radius: 50%; border: 1px solid; opacity: 0; }
        .brain-container { position: relative; width: 64px; height: 64px; }
        .brain-thinking-waves .wave1 { width: 70px; height: 70px; top: -3px; left: -3px; border-color: #ff6d00; animation: waveOut 1.2s ease-out infinite; }
        .brain-thinking-waves .wave2 { width: 82px; height: 82px; top: -9px; left: -9px; border-color: #ff6d00; animation: waveOut 1.2s ease-out 0.4s infinite; }
        .brain-thinking-waves .wave3 { width: 94px; height: 94px; top: -15px; left: -15px; border-color: #ff6d00; animation: waveOut 1.2s ease-out 0.8s infinite; }
        @keyframes waveOut { 0%{opacity:0.6; transform:scale(0.9)} 100%{opacity:0; transform:scale(1.1)} }

        .brain-status-label { font-size: 9px; text-transform: uppercase; letter-spacing: 1px; font-weight: bold; }
        .brain-status-idle { color: #4a5568; }
        .brain-status-thinking { color: #ff6d00; }
        .brain-status-done { color: #00e676; }

        .ai-content { flex: 1; }
        .ai-title { font-size: 11px; color: #2962ff; text-transform: uppercase; letter-spacing: 0.8px; font-weight: bold; margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .ai-text { font-size: 14px; color: #d1d4dc; line-height: 1.5; margin-bottom: 10px; }
        .decision-badge { display: inline-block; padding: 3px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; letter-spacing: 0.5px; margin-right: 8px; }
        .decision-ACHAT { background: #00e67622; color: #00e676; border: 1px solid #00e67644; }
        .decision-VENTE { background: #ff525222; color: #ff5252; border: 1px solid #ff525244; }
        .decision-ATTENTE { background: #ffb30022; color: #ffb300; border: 1px solid #ffb30044; }

        /* Barre de confiance */
        .conf-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .conf-label { font-size: 10px; color: #787b86; text-transform: uppercase; letter-spacing: 0.5px; white-space: nowrap; }
        .conf-bar-wrap { flex: 1; height: 5px; background: #2a2e39; border-radius: 3px; overflow: hidden; }
        .conf-bar { height: 5px; border-radius: 3px; transition: width 1s ease; width: 0%; }

        .next-cycle { font-size: 11px; color: #787b86; display: flex; align-items: center; gap: 6px; }
        .next-cycle-bar { flex: 1; height: 3px; background: #2a2e39; border-radius: 2px; overflow: hidden; }
        .next-cycle-fill { height: 100%; background: #2962ff44; border-radius: 2px; transition: width 1s linear; }

        .error-msg { color: #ff5252; text-align: center; padding: 40px; background: rgba(255,82,82,0.1); border-radius: 6px; }
        .refresh { font-size: 11px; color: #787b86; text-align: right; margin-top: 20px; opacity: 0.7; }
    </style>
</head>
<body>
<div class="container">
    <div class="card">
        <h1>üìä Trading Bot Dashboard</h1>

        <!-- Horloges -->
        <div class="clock-bar" id="clock-bar">
            <div class="clock-item">
                <div class="clock-city">üá´üá∑ Paris</div>
                <div class="clock-time" id="clock-paris">--:--:--</div>
            </div>
            <div class="clock-divider"></div>
            <div class="clock-item">
                <div class="clock-city">üá∫üá∏ New York</div>
                <div class="clock-time" id="clock-ny">--:--:--</div>
            </div>
            <div class="clock-divider"></div>
            <div id="market-status-badge"></div>
        </div>

        <div id="main"><p style="text-align:center;">Connexion au VPS en cours...</p></div>
        <div class="refresh" id="refresh-time">--:--:--</div>
    </div>
</div>

<script>
    const DATA_URL = 'https://incorporated-wit-accessibility-forever.trycloudflare.com/data';
    const REFRESH_INTERVAL = 30000;
    const BOT_CYCLE = 300;

    let cycleTimer = null;
    let lastOrderIds = [];
    let chartInstance = null;
    let currentMode = 'value';
    let brainState = 'idle'; // idle | thinking | done

    // ===================== HORLOGES =====================
    function updateClocks() {
        const now = new Date();

        const paris = now.toLocaleTimeString('fr-FR', { timeZone: 'Europe/Paris', hour12: false });
        const ny = now.toLocaleTimeString('fr-FR', { timeZone: 'America/New_York', hour12: false });
        document.getElementById('clock-paris').textContent = paris;
        document.getElementById('clock-ny').textContent = ny;

        // Heure NY pour statut march√©
        const nyDate = new Date(now.toLocaleString('en-US', { timeZone: 'America/New_York' }));
        const h = nyDate.getHours();
        const m = nyDate.getMinutes();
        const day = nyDate.getDay(); // 0=dim, 6=sam
        const timeMin = h * 60 + m;

        const badge = document.getElementById('market-status-badge');
        let html = '';
        if (day === 0 || day === 6) {
            html = `<div class="market-badge market-closed"><div class="market-dot market-dot-closed"></div>March√© ferm√© (weekend)</div>`;
        } else if (timeMin >= 570 && timeMin < 630) { // 9h30-10h30 pre-market tardif
            html = `<div class="market-badge market-prepost"><div class="market-dot market-dot-prepost"></div>Pr√©-march√©</div>`;
        } else if (timeMin >= 630 && timeMin < 960) { // 10h30 -> 16h
            // 9h30=570, 16h=960
            html = '';
        } else { html = ''; }

        // Recalcul propre : 9h30-16h = march√© ouvert
        if (day >= 1 && day <= 5) {
            if (timeMin >= 570 && timeMin < 960) {
                html = `<div class="market-badge market-open"><div class="market-dot market-dot-open"></div>NYSE Ouvert üü¢</div>`;
            } else if ((timeMin >= 240 && timeMin < 570) || (timeMin >= 960 && timeMin < 1200)) {
                html = `<div class="market-badge market-prepost"><div class="market-dot market-dot-prepost"></div>Pr√©/Post-march√©</div>`;
            } else {
                html = `<div class="market-badge market-closed"><div class="market-dot market-dot-closed"></div>NYSE Ferm√©</div>`;
            }
        } else {
            html = `<div class="market-badge market-closed"><div class="market-dot market-dot-closed"></div>March√© ferm√© (weekend)</div>`;
        }
        badge.innerHTML = html;
    }

    setInterval(updateClocks, 1000);
    updateClocks();

    // ===================== CERVEAU SVG =====================
    function brainSVG() {
        return `<svg class="brain-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
            <!-- H√©misph√®re gauche -->
            <path class="brain-fill" d="M50,20 C35,18 18,25 15,40 C12,52 16,60 22,66 C26,70 30,72 30,78 C30,82 34,85 38,85 L50,85 L50,20 Z"/>
            <!-- H√©misph√®re droit -->
            <path class="brain-fill" d="M50,20 C65,18 82,25 85,40 C88,52 84,60 78,66 C74,70 70,72 70,78 C70,82 66,85 62,85 L50,85 L50,20 Z"/>
            <!-- Corps calleux (ligne centrale) -->
            <line x1="50" y1="22" x2="50" y2="83" stroke="#131722" stroke-width="2.5"/>
            <!-- Sillons gauche -->
            <path class="brain-pulse" d="M28,38 Q22,44 26,52"/>
            <path class="brain-pulse" d="M22,52 Q20,60 26,64"/>
            <path class="brain-pulse" d="M32,28 Q26,34 30,42"/>
            <!-- Sillons droit -->
            <path class="brain-pulse" d="M72,38 Q78,44 74,52"/>
            <path class="brain-pulse" d="M78,52 Q80,60 74,64"/>
            <path class="brain-pulse" d="M68,28 Q74,34 70,42"/>
            <!-- Tronc c√©r√©bral -->
            <rect class="brain-fill" x="44" y="83" width="12" height="8" rx="3"/>
        </svg>`;
    }

    function buildBrainBlock(state, sourceLabel, sourceColor) {
        const stateClass = state === 'thinking' ? 'brain-thinking' : state === 'done' ? 'brain-done' : 'brain-idle';
        const wavesClass = state === 'thinking' ? 'brain-thinking-waves' : '';
        const statusLabel = state === 'thinking' ? 'Analyse...' : state === 'done' ? 'D√©cision prise' : 'En veille';
        const statusClass = state === 'thinking' ? 'brain-status-thinking' : state === 'done' ? 'brain-status-done' : 'brain-status-idle';

        return `
        <div class="ai-brain-wrap">
            <div class="brain-container ${wavesClass}">
                ${state === 'thinking' ? '<div class="brain-wave wave1"></div><div class="brain-wave wave2"></div><div class="brain-wave wave3"></div>' : ''}
                <div class="${stateClass}">${brainSVG()}</div>
            </div>
            <div class="brain-status-label ${statusClass}">${statusLabel}</div>
        </div>`;
    }

    function buildAiBlock(aiText, isThinking) {
        const ai = parseAiAnalysis(aiText);
        if (!ai) return '';

        const isGemini = ai.source && ai.source.toLowerCase().includes('gemini');
        const sourceLabel = isGemini ? 'Gemini AI' : 'Logique classique';
        const sourceColor = isGemini ? '#ff6d00' : '#787b86';

        const state = isThinking ? 'thinking' : (ai.decision ? 'done' : 'idle');

        let decisionHtml = ai.decision ? `<span class="decision-badge decision-${ai.decision}">${ai.decision}</span>` : '';
        let barColor = ai.confiance >= 70 ? '#00e676' : ai.confiance >= 50 ? '#ffb300' : '#ff5252';

        return `
        <div class="ai-box">
            <div class="ai-inner">
                ${buildBrainBlock(state, sourceLabel, sourceColor)}
                <div class="ai-content">
                    <div class="ai-title">Analyse IA <span style="color:${sourceColor}; font-size:10px; font-weight:normal; text-transform:none; letter-spacing:0;">${sourceLabel}</span></div>
                    <div class="ai-text">${decisionHtml}${ai.raison || '...'}</div>
                    ${ai.confiance !== null ? `
                    <div class="conf-row">
                        <span class="conf-label">Confiance</span>
                        <div class="conf-bar-wrap"><div class="conf-bar" id="conf-bar" style="width:0%; background:${barColor};" data-target="${ai.confiance}%"></div></div>
                        <span style="font-size:11px; color:${barColor}; font-weight:bold; min-width:30px;">${ai.confiance}%</span>
                    </div>` : ''}
                    <div class="next-cycle">
                        <span>Prochain cycle</span>
                        <div class="next-cycle-bar"><div class="next-cycle-fill" id="cycle-fill" style="width:0%"></div></div>
                        <span id="cycle-countdown">5:00</span>
                    </div>
                </div>
            </div>
        </div>`;
    }

    // ===================== PARSING =====================
    function parseAiAnalysis(aiText) {
        if (!aiText) return null;
        const match = aiText.match(/\[(.*?)\]\s+(ACHAT|VENTE|ATTENTE)\s+\((\d+)%\)\s*[-‚Äî]\s*(.+)/);
        if (match) return { source: match[1], decision: match[2], confiance: parseInt(match[3]), raison: match[4] };
        return { source: null, decision: null, confiance: null, raison: aiText };
    }

    // ===================== GRAPHIQUE =====================
    function buildChart(history) {
        if (!history || history.length < 2) return `<div style="height:180px; display:flex; align-items:center; justify-content:center; color:#787b86; font-size:13px;">Le graphique appara√Ætra apr√®s quelques cycles.</div>`;
        return `
        <div class="chart-tabs">
            <button class="chart-tab ${currentMode === 'value' ? 'active' : ''}" onclick="switchChart('value')">Valeur du portefeuille</button>
            <button class="chart-tab ${currentMode === 'pnl' ? 'active' : ''}" onclick="switchChart('pnl')">Performance %</button>
        </div>
        <div class="chart-wrap"><canvas id="perfChart"></canvas></div>`;
    }

    function renderChart(history) {
        if (!history || history.length < 2) return;
        const ctx = document.getElementById('perfChart');
        if (!ctx) return;
        const labels = history.map(h => h.t);
        const values = currentMode === 'value' ? history.map(h => h.v) : history.map(h => h.pnl);
        const lastVal = values[values.length - 1];
        const firstVal = values[0];
        const isPositive = lastVal >= firstVal;
        const lineColor = isPositive ? '#00e676' : '#ff5252';
        const fillColor = isPositive ? 'rgba(0,230,118,0.08)' : 'rgba(255,82,82,0.08)';
        if (chartInstance) { chartInstance.destroy(); chartInstance = null; }
        chartInstance = new Chart(ctx, {
            type: 'line',
            data: { labels, datasets: [{ data: values, borderColor: lineColor, backgroundColor: fillColor, borderWidth: 2, pointRadius: 0, pointHoverRadius: 4, fill: true, tension: 0.3 }] },
            options: {
                responsive: true, maintainAspectRatio: false,
                plugins: { legend: { display: false }, tooltip: { callbacks: { label: ctx => currentMode === 'value' ? ctx.parsed.y.toFixed(2) + ' ‚Ç¨' : (ctx.parsed.y >= 0 ? '+' : '') + ctx.parsed.y.toFixed(4) + ' %' }, backgroundColor: '#1e222d', borderColor: '#2a2e39', borderWidth: 1, titleColor: '#787b86', bodyColor: '#d1d4dc' } },
                scales: { x: { grid: { color: '#2a2e39' }, ticks: { color: '#787b86', maxTicksLimit: 6, font: { size: 10 } } }, y: { grid: { color: '#2a2e39' }, ticks: { color: '#787b86', font: { size: 10 }, callback: v => currentMode === 'value' ? v.toFixed(0) + '‚Ç¨' : v.toFixed(2) + '%' }, position: 'right' } }
            }
        });
    }

    window.switchChart = function(mode) {
        currentMode = mode;
        document.querySelectorAll('.chart-tab').forEach(t => t.classList.remove('active'));
        event.target.classList.add('active');
        if (window._lastHistory) renderChart(window._lastHistory);
    };

    // ===================== ORDRES =====================
    function buildOrdersBlock(orders) {
        if (!orders || orders.length === 0) return `<p style="color:#787b86; font-style:italic; padding:10px 0;">Aucun ordre r√©cent.</p>`;
        let html = `<table><thead><tr><th>Date</th><th>Symbole</th><th>C√¥t√©</th><th>Qt√©</th><th>Prix</th><th>Statut</th></tr></thead><tbody>`;
        orders.forEach((o, i) => {
            const isNew = !lastOrderIds.includes(o.id) && i === 0;
            const sideClass = o.side === 'buy' ? 'side-buy' : 'side-sell';
            const sideLabel = o.side === 'buy' ? '‚ñ≤ ACHAT' : '‚ñº VENTE';
            const statusClass = `order-${o.status}`;
            const statusLabel = { filled: 'Ex√©cut√©', partially_filled: 'Partiel', new: 'En attente', accepted: 'En attente', canceled: 'Annul√©', rejected: 'Rejet√©' }[o.status] || o.status;
            const price = o.filled_price ? o.filled_price.toFixed(2) + '$' : '‚Äî';
            html += `<tr class="${isNew ? 'order-new-row' : ''}"><td style="color:#787b86; font-size:12px;">${o.created_at}</td><td><b>${o.symbol}</b></td><td class="${sideClass}">${sideLabel}</td><td>${o.filled_qty}/${o.qty}</td><td>${price}</td><td><span class="order-badge ${statusClass}">${statusLabel}</span></td></tr>`;
        });
        html += `</tbody></table>`;
        lastOrderIds = orders.map(o => o.id);
        return html;
    }

    // ===================== CYCLE COUNTDOWN =====================
    function startCycleCountdown() {
        clearInterval(cycleTimer);
        let s = 0;
        cycleTimer = setInterval(() => {
            s++;
            const rem = BOT_CYCLE - (s % BOT_CYCLE);
            const pct = ((s % BOT_CYCLE) / BOT_CYCLE) * 100;
            const fill = document.getElementById('cycle-fill');
            const cd = document.getElementById('cycle-countdown');
            if (fill) fill.style.width = pct + '%';
            if (cd) cd.textContent = `${Math.floor(rem/60)}:${(rem%60).toString().padStart(2,'0')}`;
        }, 1000);
    }

    // ===================== DASHBOARD =====================
    function updateDashboard() {
        // Cerveau en mode thinking pendant le fetch
        const brain = document.querySelector('.brain-container');
        if (brain) {
            const brainDiv = brain.querySelector('div');
            if (brainDiv) { brainDiv.className = 'brain-thinking'; }
            brain.className = 'brain-container brain-thinking-waves';
            brain.innerHTML = '<div class="brain-wave wave1"></div><div class="brain-wave wave2"></div><div class="brain-wave wave3"></div><div class="brain-thinking">' + brainSVG() + '</div>';
            const lbl = document.querySelector('.brain-status-label');
            if (lbl) { lbl.textContent = 'Analyse...'; lbl.className = 'brain-status-label brain-status-thinking'; }
        }

        fetch(DATA_URL)
            .then(r => { if (!r.ok) throw new Error(); return r.json(); })
            .then(data => {
                const isRunning = data.status === 'Running';
                const pnlClass = data.daily_pnl >= 0 ? 'profit' : 'loss';
                const pnlSign = data.daily_pnl >= 0 ? '+' : '';

                let positionsHtml = `<p style="color:#787b86; font-style:italic; padding:10px 0;">Aucune position ouverte.</p>`;
                if (data.positions && data.positions.length > 0) {
                    positionsHtml = `<table><thead><tr><th>Symbole</th><th>Quantit√©</th><th>Performance</th></tr></thead><tbody>`;
                    data.positions.forEach(p => {
                        const pClass = p.pnl >= 0 ? 'profit' : 'loss';
                        positionsHtml += `<tr><td><b>${p.symbol}</b></td><td>${p.qty}</td><td class="${pClass}">${p.pnl >= 0 ? '+' : ''}${p.pnl.toFixed(2)}%</td></tr>`;
                    });
                    positionsHtml += `</tbody></table>`;
                }

                window._lastHistory = data.history || [];
                const chartHtml = buildChart(window._lastHistory);

                let gainTotal = '';
                if (window._lastHistory && window._lastHistory.length > 1) {
                    const diff = window._lastHistory[window._lastHistory.length-1].v - window._lastHistory[0].v;
                    const diffPct = ((diff / window._lastHistory[0].v) * 100).toFixed(3);
                    gainTotal = `<span class="${diff >= 0 ? 'profit' : 'loss'}" style="font-size:13px; font-weight:bold;">${diff >= 0 ? '+' : ''}${diff.toFixed(2)}‚Ç¨ (${diff >= 0 ? '+' : ''}${diffPct}%)</span>`;
                }

                document.getElementById('main').innerHTML = `
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                        <div>Statut : <span class="status-badge ${isRunning ? 'status-running' : 'status-stopped'}">${data.status}</span></div>
                    </div>
                    <div class="grid">
                        <div class="stat-box"><div class="stat-label">Valeur Totale</div><div class="stat-value">${data.portfolio_value.toFixed(2)} ‚Ç¨</div></div>
                        <div class="stat-box"><div class="stat-label">Cash Disponible</div><div class="stat-value">${data.cash.toFixed(2)} ‚Ç¨</div></div>
                        <div class="stat-box"><div class="stat-label">Performance Jour</div><div class="stat-value ${pnlClass}">${pnlSign}${data.daily_pnl.toFixed(2)} %</div></div>
                    </div>
                    <h3>üìà Positions en cours</h3>
                    ${positionsHtml}
                    <h3>üìâ Performance en temps r√©el ${gainTotal}</h3>
                    ${chartHtml}
                    ${buildAiBlock(data.ai_analysis, false)}
                    <h3>üìã Ordres r√©cents</h3>
                    ${buildOrdersBlock(data.orders)}
                    <p style="margin-top:16px; color:#787b86; font-size:13px;"><strong>Log :</strong> ${data.message}</p>
                `;

                setTimeout(() => renderChart(window._lastHistory), 50);
                const bar = document.getElementById('conf-bar');
                if (bar) setTimeout(() => { bar.style.width = bar.getAttribute('data-target'); }, 200);
                startCycleCountdown();
                document.getElementById('refresh-time').innerText = "Derni√®re mise √† jour : " + new Date().toLocaleTimeString();
            })
            .catch(() => {
                document.getElementById('main').innerHTML = `<div class="error-msg"><strong>‚ö†Ô∏è Erreur de connexion</strong><br><br>Impossible de joindre le serveur.</div>`;
            });
    }

    updateDashboard();
    setInterval(updateDashboard, REFRESH_INTERVAL);
</script>
</body>
</html>
