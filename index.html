<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>NabilH â€” Trading Bot</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
:root {
  --bg:       #0c0e14;
  --surface:  #13161f;
  --surface2: #1c2030;
  --border:   #252a3a;
  --text:     #e2e8f0;
  --muted:    #4a5568;
  --green:    #00d97e;
  --red:      #ff4757;
  --blue:     #3d7fff;
  --orange:   #ff7c3a;
  --purple:   #8b5cf6;
  --green-bg: rgba(0,217,126,.1);
  --red-bg:   rgba(255,71,87,.1);
  --blue-bg:  rgba(61,127,255,.1);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: 'Outfit', sans-serif;
  background: var(--bg);
  color: var(--text);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€ HEADER â”€â”€ */
.header {
  background: var(--surface);
  border-bottom: 1px solid var(--border);
  padding: 14px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  position: sticky;
  top: 0;
  z-index: 100;
  backdrop-filter: blur(12px);
}
.header-brand { display: flex; align-items: center; gap: 10px; }
.header-logo { font-weight: 800; font-size: 18px; color: var(--blue); letter-spacing: -0.5px; }
.header-sub { font-size: 11px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
.header-right { display: flex; align-items: center; gap: 12px; }

/* â”€â”€ STATUS DOT â”€â”€ */
.live-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--green); box-shadow: 0 0 8px var(--green); animation: pulse 1.5s infinite; }
@keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:.5;transform:scale(1.3)} }
.live-label { font-size: 11px; color: var(--green); font-weight: 600; font-family: 'JetBrains Mono', monospace; }

/* â”€â”€ LAYOUT â”€â”€ */
.page { max-width: 960px; margin: 0 auto; padding: 20px 16px 40px; }

/* â”€â”€ CLOCK BAR â”€â”€ */
.clock-bar {
  display: flex; align-items: center; gap: 0;
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; overflow: hidden; margin-bottom: 20px;
}
.clock-cell {
  flex: 1; padding: 12px 16px;
  border-right: 1px solid var(--border);
  display: flex; flex-direction: column; align-items: center; gap: 3px;
}
.clock-cell:last-child { border-right: none; }
.clock-flag { font-size: 18px; line-height: 1; }
.clock-city { font-size: 9px; color: var(--muted); text-transform: uppercase; letter-spacing: 1.5px; font-family: 'JetBrains Mono', monospace; }
.clock-time { font-size: 17px; font-weight: 700; color: var(--text); font-family: 'JetBrains Mono', monospace; letter-spacing: 1px; }
.market-status { padding: 3px 10px; border-radius: 20px; font-size: 10px; font-weight: 700; letter-spacing: .5px; display: flex; align-items: center; gap: 5px; }
.ms-open   { background: var(--green-bg); color: var(--green); border: 1px solid rgba(0,217,126,.25); }
.ms-closed { background: var(--red-bg);   color: var(--red);   border: 1px solid rgba(255,71,87,.25); }
.ms-pre    { background: rgba(255,124,58,.1); color: var(--orange); border: 1px solid rgba(255,124,58,.25); }
.ms-dot { width: 6px; height: 6px; border-radius: 50%; }
.ms-dot-open   { background: var(--green); animation: pulse 1.5s infinite; }
.ms-dot-closed { background: var(--red); }
.ms-dot-pre    { background: var(--orange); animation: pulse 2s infinite; }

/* â”€â”€ STATS GRID â”€â”€ */
.stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 20px; }
.stat-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 16px;
  transition: border-color .2s, transform .2s;
}
.stat-card:hover { border-color: var(--blue); transform: translateY(-2px); }
.stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; font-family: 'JetBrains Mono', monospace; }
.stat-value { font-size: 22px; font-weight: 700; color: var(--text); line-height: 1; }
.stat-value.green { color: var(--green); }
.stat-value.red   { color: var(--red);   }
.stat-sub { font-size: 11px; color: var(--muted); margin-top: 4px; }

/* â”€â”€ SECTION TITLE â”€â”€ */
.section-title {
  font-size: 12px; font-weight: 600; color: var(--muted);
  text-transform: uppercase; letter-spacing: 1.5px;
  font-family: 'JetBrains Mono', monospace;
  margin: 24px 0 12px;
  display: flex; align-items: center; gap: 8px;
}
.section-title::after { content: ''; flex: 1; height: 1px; background: var(--border); }

/* â”€â”€ CARTE GÃ‰NÃ‰RIQUE â”€â”€ */
.card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 20px; margin-bottom: 12px;
}

/* â”€â”€ POSITIONS â”€â”€ */
.pos-row {
  display: flex; align-items: center; justify-content: space-between;
  padding: 12px 0; border-bottom: 1px solid var(--border);
}
.pos-row:last-child { border-bottom: none; }
.pos-symbol { font-weight: 700; font-size: 16px; font-family: 'JetBrains Mono', monospace; }
.pos-qty { font-size: 12px; color: var(--muted); margin-top: 2px; }
.pos-pnl { font-size: 18px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.pos-pnl.green { color: var(--green); }
.pos-pnl.red   { color: var(--red);   }

/* â”€â”€ GRAPHIQUE INTRADAY â”€â”€ */
.chart-tabs { display: flex; gap: 6px; margin-bottom: 14px; }
.chart-tab {
  padding: 5px 14px; border-radius: 6px; font-size: 11px; font-weight: 600;
  cursor: pointer; border: 1px solid var(--border); background: transparent;
  color: var(--muted); transition: all .2s; font-family: 'JetBrains Mono', monospace;
}
.chart-tab.active { background: var(--blue-bg); border-color: rgba(61,127,255,.4); color: var(--blue); }
.chart-wrap { position: relative; height: 160px; }

/* â”€â”€ VUE JOURNALIÃˆRE â”€â”€ */
.daily-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(130px, 1fr)); gap: 8px; }
.day-card {
  background: var(--surface2); border: 1px solid var(--border);
  border-radius: 10px; padding: 12px 14px;
  transition: transform .15s, border-color .15s;
  cursor: default;
}
.day-card:hover { transform: translateY(-2px); }
.day-card.day-green { border-color: rgba(0,217,126,.3); background: rgba(0,217,126,.05); }
.day-card.day-red   { border-color: rgba(255,71,87,.3);  background: rgba(255,71,87,.05);  }
.day-card.day-zero  { border-color: var(--border); }
.day-date { font-size: 10px; color: var(--muted); font-family: 'JetBrains Mono', monospace; margin-bottom: 8px; }
.day-pnl  { font-size: 20px; font-weight: 800; line-height: 1; }
.day-pnl.green { color: var(--green); }
.day-pnl.red   { color: var(--red);   }
.day-pnl.zero  { color: var(--muted); }
.day-pnl-sub { font-size: 11px; color: var(--muted); margin-top: 4px; font-family: 'JetBrains Mono', monospace; }
.day-bar-wrap { height: 3px; background: var(--border); border-radius: 2px; margin-top: 8px; overflow: hidden; }
.day-bar { height: 100%; border-radius: 2px; transition: width .5s ease; }
.day-bar.green { background: var(--green); }
.day-bar.red   { background: var(--red);   }

/* â”€â”€ CERVEAU IA â”€â”€ */
.ai-card {
  background: var(--surface); border: 1px solid var(--border);
  border-radius: 12px; padding: 20px; margin-bottom: 12px;
  display: flex; align-items: flex-start; gap: 20px;
}
.brain-wrap { flex-shrink: 0; display: flex; flex-direction: column; align-items: center; gap: 6px; }
.brain-container { position: relative; width: 60px; height: 60px; }
.brain-svg { width: 60px; height: 60px; }
.brain-fill { transition: fill .4s ease; }
.brain-pulse { fill: none; stroke-width: 1.5; }
.brain-idle     .brain-fill  { fill: #1e2a50; }
.brain-idle     .brain-pulse { stroke: var(--blue); opacity: .25; }
.brain-thinking .brain-fill  { fill: #7a3200; }
.brain-thinking .brain-pulse { stroke: var(--orange); animation: bp .6s ease-in-out infinite; }
.brain-done     .brain-fill  { fill: #00513a; }
.brain-done     .brain-pulse { stroke: var(--green); animation: bp 2s ease-in-out infinite; }
@keyframes bp { 0%,100%{opacity:.15;transform:scale(1)} 50%{opacity:1;transform:scale(1.2)} }
.bwave { position: absolute; border-radius: 50%; border: 1px solid var(--orange); opacity: 0; }
.bwave1 { width:66px;height:66px;top:-3px;left:-3px; animation: wo 1s ease-out infinite; }
.bwave2 { width:78px;height:78px;top:-9px;left:-9px; animation: wo 1s ease-out .33s infinite; }
.bwave3 { width:90px;height:90px;top:-15px;left:-15px; animation: wo 1s ease-out .66s infinite; }
@keyframes wo { 0%{opacity:.6;transform:scale(.9)} 100%{opacity:0;transform:scale(1.1)} }
.brain-lbl { font-size: 8px; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.brain-lbl-idle     { color: var(--muted);  }
.brain-lbl-thinking { color: var(--orange); }
.brain-lbl-done     { color: var(--green);  }
.ai-content { flex: 1; min-width: 0; }
.ai-source { font-size: 10px; color: var(--muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 6px; font-family: 'JetBrains Mono', monospace; }
.ai-decision-row { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
.decision-chip { padding: 4px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.dc-ACHAT   { background: var(--green-bg); color: var(--green); border: 1px solid rgba(0,217,126,.3); }
.dc-VENTE   { background: var(--red-bg);   color: var(--red);   border: 1px solid rgba(255,71,87,.3); }
.dc-ATTENTE { background: rgba(255,124,58,.1); color: var(--orange); border: 1px solid rgba(255,124,58,.3); }
.trail-chip { padding: 3px 8px; border-radius: 5px; font-size: 10px; font-weight: 700; background: rgba(139,92,246,.15); color: var(--purple); border: 1px solid rgba(139,92,246,.3); }
.ai-raison { font-size: 13px; color: var(--text); line-height: 1.5; margin-bottom: 10px; }
.conf-row { display: flex; align-items: center; gap: 10px; }
.conf-label { font-size: 10px; color: var(--muted); white-space: nowrap; font-family: 'JetBrains Mono', monospace; }
.conf-track { flex: 1; height: 4px; background: var(--surface2); border-radius: 2px; overflow: hidden; }
.conf-fill  { height: 100%; border-radius: 2px; transition: width 1s ease; width: 0; }
.conf-pct { font-size: 11px; font-weight: 700; font-family: 'JetBrains Mono', monospace; min-width: 32px; text-align: right; }
.cycle-row { display: flex; align-items: center; gap: 8px; margin-top: 10px; }
.cycle-label { font-size: 10px; color: var(--muted); white-space: nowrap; font-family: 'JetBrains Mono', monospace; }
.cycle-track { flex: 1; height: 2px; background: var(--surface2); border-radius: 2px; overflow: hidden; }
.cycle-fill  { height: 100%; background: var(--blue); border-radius: 2px; transition: width 1s linear; width: 0; }
.cycle-cd { font-size: 10px; color: var(--muted); font-family: 'JetBrains Mono', monospace; min-width: 32px; text-align: right; }

/* â”€â”€ ORDRES â”€â”€ */
.orders-list { display: flex; flex-direction: column; gap: 6px; }
.order-row {
  display: flex; align-items: center; gap: 10px;
  background: var(--surface2); border-radius: 8px; padding: 10px 14px;
  border: 1px solid var(--border); flex-wrap: wrap;
}
.order-side-buy  { color: var(--green); font-weight: 700; font-size: 12px; font-family: 'JetBrains Mono', monospace; min-width: 60px; }
.order-side-sell { color: var(--red);   font-weight: 700; font-size: 12px; font-family: 'JetBrains Mono', monospace; min-width: 60px; }
.order-sym  { font-weight: 700; font-size: 14px; font-family: 'JetBrains Mono', monospace; }
.order-qty  { font-size: 12px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
.order-price { font-size: 13px; font-weight: 600; font-family: 'JetBrains Mono', monospace; margin-left: auto; }
.order-date { font-size: 10px; color: var(--muted); font-family: 'JetBrains Mono', monospace; }
.order-chip { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 700; font-family: 'JetBrains Mono', monospace; }
.oc-filled  { background: var(--green-bg); color: var(--green); }
.oc-partial { background: rgba(255,124,58,.1); color: var(--orange); }
.oc-pending { background: var(--blue-bg); color: var(--blue); }
.oc-cancel  { background: var(--red-bg); color: var(--red); }

@keyframes flashNew { 0%,100%{background:var(--surface2)} 40%{background:rgba(61,127,255,.12)} }
.order-new-anim { animation: flashNew 1.5s ease 3; }

/* â”€â”€ ERREUR â”€â”€ */
.error-card {
  background: var(--red-bg); border: 1px solid rgba(255,71,87,.3);
  border-radius: 12px; padding: 32px; text-align: center; color: var(--red);
}
.error-card strong { font-size: 16px; display: block; margin-bottom: 8px; }
.error-card p { font-size: 13px; color: var(--muted); }

/* â”€â”€ FOOTER â”€â”€ */
.footer { font-size: 11px; color: var(--muted); text-align: right; margin-top: 8px; font-family: 'JetBrains Mono', monospace; }

/* â”€â”€ RESPONSIVE â”€â”€ */
@media (max-width: 600px) {
  .stats-grid { grid-template-columns: repeat(2, 1fr); }
  .stat-value { font-size: 18px; }
  .clock-time { font-size: 14px; }
  .clock-flag { font-size: 14px; }
  .ai-card { flex-direction: column; gap: 14px; }
  .brain-wrap { flex-direction: row; gap: 12px; align-items: center; }
  .daily-grid { grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); }
  .day-pnl { font-size: 16px; }
  .order-price { margin-left: 0; }
  .header-sub { display: none; }
}
@media (max-width: 380px) {
  .stats-grid { grid-template-columns: 1fr 1fr; }
  .clock-bar { flex-wrap: wrap; }
  .clock-cell { min-width: 33%; }
}
</style>
</head>
<body>

<!-- HEADER -->
<header class="header">
  <div class="header-brand">
    <div>
      <div class="header-logo">NabilH</div>
      <div class="header-sub">Trading Bot Â· SPY Â· Paper</div>
    </div>
  </div>
  <div class="header-right">
    <div class="live-dot" id="live-dot"></div>
    <span class="live-label" id="live-label">LIVE</span>
  </div>
</header>

<div class="page">

  <!-- HORLOGES -->
  <div class="clock-bar">
    <div class="clock-cell">
      <div class="clock-flag">ğŸ‡«ğŸ‡·</div>
      <div class="clock-city">Paris</div>
      <div class="clock-time" id="clock-paris">--:--:--</div>
    </div>
    <div class="clock-cell">
      <div class="clock-flag">ğŸ‡ºğŸ‡¸</div>
      <div class="clock-city">New York</div>
      <div class="clock-time" id="clock-ny">--:--:--</div>
    </div>
    <div class="clock-cell">
      <div class="clock-city">NYSE</div>
      <div id="market-badge" style="margin-top:4px"></div>
    </div>
  </div>

  <!-- STATS -->
  <div id="stats-grid" class="stats-grid">
    <div class="stat-card"><div class="stat-label">Portefeuille</div><div class="stat-value" id="s-equity">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Cash</div><div class="stat-value" id="s-cash">â€”</div></div>
    <div class="stat-card"><div class="stat-label">Perf. Jour</div><div class="stat-value" id="s-pnl">â€”</div><div class="stat-sub" id="s-status">â€”</div></div>
  </div>

  <!-- POSITIONS -->
  <div class="section-title">ğŸ“ˆ Positions</div>
  <div class="card" id="positions-card"><p style="color:var(--muted);font-size:13px">Chargement...</p></div>

  <!-- GRAPHIQUE INTRADAY -->
  <div class="section-title">ğŸ“‰ Performance intraday</div>
  <div class="card" id="chart-card">
    <div style="height:160px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px">DonnÃ©es en cours d'accumulation...</div>
  </div>

  <!-- VUE JOURNALIÃˆRE -->
  <div class="section-title">ğŸ“… Historique journalier</div>
  <div id="daily-section">
    <div class="card"><p style="color:var(--muted);font-size:13px">Chargement...</p></div>
  </div>

  <!-- BLOC IA -->
  <div class="section-title">ğŸ¤– Analyse IA</div>
  <div class="ai-card" id="ai-card">
    <div class="brain-wrap">
      <div class="brain-container" id="brain-container">
        <div class="brain-idle" id="brain-inner"></div>
      </div>
      <div class="brain-lbl brain-lbl-idle" id="brain-lbl">En veille</div>
    </div>
    <div class="ai-content" id="ai-content">
      <div class="ai-source">Initialisation...</div>
    </div>
  </div>

  <!-- ORDRES -->
  <div class="section-title">ğŸ“‹ Ordres rÃ©cents</div>
  <div id="orders-section"><div class="card"><p style="color:var(--muted);font-size:13px">Chargement...</p></div></div>

  <div class="footer" id="refresh-time">â€”</div>
</div>

<script>
const DATA_URL   = 'https://incorporated-wit-accessibility-forever.trycloudflare.com/api/state';
const REFRESH    = 30000;
const BOT_CYCLE  = 300;

let chartInstance = null;
let currentMode   = 'value';
let cycleTimer    = null;
let lastOrderIds  = [];

// â”€â”€ Horloges â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateClocks() {
  const now = new Date();
  document.getElementById('clock-paris').textContent = now.toLocaleTimeString('fr-FR',{timeZone:'Europe/Paris',hour12:false});
  document.getElementById('clock-ny').textContent    = now.toLocaleTimeString('fr-FR',{timeZone:'America/New_York',hour12:false});
  const ny  = new Date(now.toLocaleString('en-US',{timeZone:'America/New_York'}));
  const t   = ny.getHours()*60 + ny.getMinutes();
  const day = ny.getDay();
  const el  = document.getElementById('market-badge');
  if(day===0||day===6){
    el.innerHTML=`<div class="market-status ms-closed"><div class="ms-dot ms-dot-closed"></div>Weekend</div>`;
  } else if(t>=570&&t<960){
    el.innerHTML=`<div class="market-status ms-open"><div class="ms-dot ms-dot-open"></div>Ouvert</div>`;
  } else if((t>=240&&t<570)||(t>=960&&t<1200)){
    el.innerHTML=`<div class="market-status ms-pre"><div class="ms-dot ms-dot-pre"></div>PrÃ©/Post</div>`;
  } else {
    el.innerHTML=`<div class="market-status ms-closed"><div class="ms-dot ms-dot-closed"></div>FermÃ©</div>`;
  }
}
setInterval(updateClocks,1000); updateClocks();

// â”€â”€ Cerveau SVG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function brainSVG() {
  return `<svg class="brain-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <path class="brain-fill" d="M50,20 C35,18 18,25 15,40 C12,52 16,60 22,66 C26,70 30,72 30,78 C30,82 34,85 38,85 L50,85 L50,20 Z"/>
    <path class="brain-fill" d="M50,20 C65,18 82,25 85,40 C88,52 84,60 78,66 C74,70 70,72 70,78 C70,82 66,85 62,85 L50,85 L50,20 Z"/>
    <line x1="50" y1="22" x2="50" y2="83" stroke="#0c0e14" stroke-width="2.5"/>
    <path class="brain-pulse" d="M28,38 Q22,44 26,52"/>
    <path class="brain-pulse" d="M22,52 Q20,60 26,64"/>
    <path class="brain-pulse" d="M32,28 Q26,34 30,42"/>
    <path class="brain-pulse" d="M72,38 Q78,44 74,52"/>
    <path class="brain-pulse" d="M78,52 Q80,60 74,64"/>
    <path class="brain-pulse" d="M68,28 Q74,34 70,42"/>
    <rect class="brain-fill" x="44" y="83" width="12" height="8" rx="3"/>
  </svg>`;
}

function setBrain(state) {
  const container = document.getElementById('brain-container');
  const lbl       = document.getElementById('brain-lbl');
  if(!container||!lbl) return;
  const labels = {idle:'En veille',thinking:'Analyse...',done:'DÃ©cision'};
  const waves  = state==='thinking' ? '<div class="bwave bwave1"></div><div class="bwave bwave2"></div><div class="bwave bwave3"></div>' : '';
  container.innerHTML = `${waves}<div class="brain-${state}">${brainSVG()}</div>`;
  lbl.textContent  = labels[state]||'';
  lbl.className    = `brain-lbl brain-lbl-${state}`;
}

// â”€â”€ Vue journaliÃ¨re â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildDaily(daily) {
  if(!daily||!daily.length) {
    return `<div class="card"><p style="color:var(--muted);font-size:13px;padding:4px 0">Les donnÃ©es journaliÃ¨res apparaÃ®tront aprÃ¨s la premiÃ¨re journÃ©e de trading.</p></div>`;
  }
  // Trier du plus rÃ©cent au plus ancien
  const sorted = [...daily].reverse();
  // Max abs pnl pour normaliser les barres
  const maxAbs = Math.max(...daily.map(d=>Math.abs(d.pnl||0)), 0.01);
  let html = `<div class="daily-grid">`;
  sorted.forEach(d => {
    const pnl    = d.pnl    || 0;
    const pnlPct = d.pnl_pct || 0;
    const isPos  = pnl > 0;
    const isZero = Math.abs(pnl) < 0.01;
    const cls    = isZero ? 'day-zero' : isPos ? 'day-green' : 'day-red';
    const pnlCls = isZero ? 'zero'     : isPos ? 'green'     : 'red';
    const barPct = Math.round((Math.abs(pnl) / maxAbs) * 100);
    const sign   = pnl > 0 ? '+' : '';
    // Formater date JJ/MM
    const dateStr = d.date ? d.date.split('-').slice(1).reverse().join('/') : 'â€”';
    html += `<div class="day-card ${cls}">
      <div class="day-date">${dateStr}</div>
      <div class="day-pnl ${pnlCls}">${sign}${pnl.toFixed(2)}â‚¬</div>
      <div class="day-pnl-sub">${sign}${pnlPct.toFixed(3)}%</div>
      <div class="day-bar-wrap"><div class="day-bar ${pnlCls}" style="width:${barPct}%"></div></div>
    </div>`;
  });
  html += `</div>`;
  return html;
}

// â”€â”€ Graphique â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildChartHtml(history) {
  if(!history||history.length<2) {
    return `<div style="height:160px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px">DonnÃ©es en cours d'accumulation...</div>`;
  }
  return `<div class="chart-tabs">
    <button class="chart-tab ${currentMode==='value'?'active':''}" onclick="switchChart(event,'value')">Valeur â‚¬</button>
    <button class="chart-tab ${currentMode==='pnl'?'active':''}" onclick="switchChart(event,'pnl')">Perf. %</button>
  </div><div class="chart-wrap"><canvas id="perfChart"></canvas></div>`;
}

function renderChart(history) {
  if(!history||history.length<2) return;
  const ctx = document.getElementById('perfChart');
  if(!ctx) return;
  const vals  = currentMode==='value' ? history.map(h=>h.v) : history.map(h=>h.pnl);
  const isPos = vals[vals.length-1] >= vals[0];
  const col   = isPos ? '#00d97e' : '#ff4757';
  const fill  = isPos ? 'rgba(0,217,126,.07)' : 'rgba(255,71,87,.07)';
  if(chartInstance){chartInstance.destroy();chartInstance=null;}
  chartInstance = new Chart(ctx,{
    type:'line',
    data:{labels:history.map(h=>h.t),datasets:[{data:vals,borderColor:col,backgroundColor:fill,borderWidth:2,pointRadius:0,pointHoverRadius:5,fill:true,tension:.35}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false,callbacks:{label:c=>currentMode==='value'?c.parsed.y.toFixed(2)+' â‚¬':(c.parsed.y>=0?'+':'')+c.parsed.y.toFixed(4)+' %'},backgroundColor:'#13161f',borderColor:'#252a3a',borderWidth:1,titleColor:'#4a5568',bodyColor:'#e2e8f0',padding:10}},
      scales:{x:{grid:{color:'rgba(37,42,58,.8)'},ticks:{color:'#4a5568',maxTicksLimit:6,font:{size:10,family:'JetBrains Mono'}}},y:{grid:{color:'rgba(37,42,58,.8)'},ticks:{color:'#4a5568',font:{size:10,family:'JetBrains Mono'},callback:v=>currentMode==='value'?v.toFixed(0)+'â‚¬':v.toFixed(2)+'%'},position:'right'}}}
  });
}
window.switchChart = function(e,mode){
  currentMode=mode;
  document.querySelectorAll('.chart-tab').forEach(t=>t.classList.remove('active'));
  e.target.classList.add('active');
  if(window._lastHistory) renderChart(window._lastHistory);
};

// â”€â”€ Bloc IA â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateAiBlock(ai, thinking) {
  const state     = thinking ? 'thinking' : (ai&&ai.decision ? 'done' : 'idle');
  const isGemini  = ai && ai.source && ai.source.toLowerCase().includes('gemini');
  const srcLabel  = isGemini ? 'Gemini 1.5 Flash' : 'Logique classique';
  const barColor  = !ai ? '#3d7fff' : (ai.confiance||0)>=70 ? '#00d97e' : (ai.confiance||0)>=50 ? '#ff7c3a' : '#ff4757';
  const conf      = ai ? (ai.confiance||0) : 0;
  const decision  = ai ? (ai.decision||'ATTENTE') : 'ATTENTE';
  const raison    = ai ? (ai.raison||'...') : '...';
  setBrain(state);
  document.getElementById('ai-content').innerHTML = `
    <div class="ai-source">${srcLabel}</div>
    <div class="ai-decision-row">
      <div class="decision-chip dc-${decision}">${decision}</div>
      ${ai&&ai.trailing_stop ? '<div class="trail-chip">ğŸ›¡ Trailing Stop</div>' : ''}
    </div>
    <div class="ai-raison">${raison}</div>
    <div class="conf-row">
      <span class="conf-label">Confiance</span>
      <div class="conf-track"><div class="conf-fill" id="conf-fill" style="width:0%;background:${barColor}"></div></div>
      <span class="conf-pct" style="color:${barColor}">${conf}%</span>
    </div>
    <div class="cycle-row">
      <span class="cycle-label">Prochain cycle</span>
      <div class="cycle-track"><div class="cycle-fill" id="cycle-fill" style="width:0%"></div></div>
      <span class="cycle-cd" id="cycle-cd">5:00</span>
    </div>`;
  setTimeout(()=>{
    const f=document.getElementById('conf-fill');
    if(f) f.style.width=conf+'%';
  },200);
}

// â”€â”€ Ordres â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildOrders(orders) {
  if(!orders||!orders.length) return `<div class="card"><p style="color:var(--muted);font-size:13px">Aucun ordre rÃ©cent.</p></div>`;
  const chips = {filled:['oc-filled','ExÃ©cutÃ©'],partially_filled:['oc-partial','Partiel'],new:['oc-pending','Attente'],accepted:['oc-pending','Attente'],canceled:['oc-cancel','AnnulÃ©'],rejected:['oc-cancel','RejetÃ©']};
  let html=`<div class="orders-list">`;
  orders.forEach((o,i)=>{
    const isNew = !lastOrderIds.includes(o.id) && i===0;
    const [chipCls,chipLbl] = chips[o.status]||['oc-pending',o.status];
    const isBuy = o.side==='buy';
    html+=`<div class="order-row ${isNew?'order-new-anim':''}">
      <div class="${isBuy?'order-side-buy':'order-side-sell'}">${isBuy?'â–² BUY':'â–¼ SELL'}</div>
      <div class="order-sym">${o.symbol}</div>
      <div class="order-qty">${o.filled_qty}/${o.qty}</div>
      <span class="order-chip ${chipCls}">${chipLbl}</span>
      <div class="order-price">${o.filled_price?o.filled_price.toFixed(2)+'$':'â€”'}</div>
      <div class="order-date">${o.created_at}</div>
    </div>`;
  });
  html+=`</div>`;
  lastOrderIds = orders.map(o=>o.id);
  return html;
}

// â”€â”€ Countdown â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startCycle() {
  clearInterval(cycleTimer);
  let s=0;
  cycleTimer=setInterval(()=>{
    s++;
    const rem=BOT_CYCLE-(s%BOT_CYCLE);
    const pct=((s%BOT_CYCLE)/BOT_CYCLE)*100;
    const f=document.getElementById('cycle-fill');
    const c=document.getElementById('cycle-cd');
    if(f) f.style.width=pct+'%';
    if(c) c.textContent=`${Math.floor(rem/60)}:${(rem%60).toString().padStart(2,'0')}`;
  },1000);
}

// â”€â”€ Update principal â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function updateDashboard() {
  // Cerveau en thinking
  setBrain('thinking');
  document.getElementById('live-label').textContent='SYNC';

  fetch(DATA_URL)
  .then(r=>{ if(!r.ok) throw new Error('HTTP '+r.status); return r.json(); })
  .then(data=>{
    const ai  = data.ai_analysis||{};
    const pos = data.positions||[];
    const pnl = data.daily_pnl||0;

    // Stats
    document.getElementById('s-equity').textContent = (data.portfolio_value||0).toFixed(2)+' â‚¬';
    document.getElementById('s-cash').textContent   = (data.cash||0).toFixed(2)+' â‚¬';
    const pnlEl = document.getElementById('s-pnl');
    pnlEl.textContent = (pnl>=0?'+':'')+pnl.toFixed(3)+' %';
    pnlEl.className   = 'stat-value '+(pnl>=0?'green':'red');
    document.getElementById('s-status').textContent = data.status||'â€”';

    // Positions
    let posHtml = `<p style="color:var(--muted);font-size:13px;padding:4px 0">Aucune position ouverte.</p>`;
    if(pos.length){
      posHtml='';
      pos.forEach(p=>{
        const isPos=p.pnl>=0;
        posHtml+=`<div class="pos-row">
          <div><div class="pos-symbol">${p.symbol}</div><div class="pos-qty">${p.qty} actions</div></div>
          <div class="pos-pnl ${isPos?'green':'red'}">${isPos?'+':''}${p.pnl.toFixed(2)}%</div>
        </div>`;
      });
    }
    document.getElementById('positions-card').innerHTML=posHtml;

    // Graphique
    window._lastHistory=data.history||[];
    document.getElementById('chart-card').innerHTML=buildChartHtml(window._lastHistory);
    setTimeout(()=>renderChart(window._lastHistory),50);

    // Journalier
    document.getElementById('daily-section').innerHTML=buildDaily(data.daily_history||[]);

    // IA
    updateAiBlock(ai, false);

    // Ordres
    document.getElementById('orders-section').innerHTML=buildOrders(data.orders||[]);

    // Live dot
    document.getElementById('live-dot').style.background='var(--green)';
    document.getElementById('live-label').textContent='LIVE';

    startCycle();
    document.getElementById('refresh-time').textContent='Mise Ã  jour : '+new Date().toLocaleTimeString();
  })
  .catch(err=>{
    document.getElementById('positions-card').innerHTML=`<div class="error-card"><strong>âš ï¸ Connexion perdue</strong><p>${err.message} â€” VÃ©rifiez VPS et tunnel.</p></div>`;
    document.getElementById('live-dot').style.background='var(--red)';
    document.getElementById('live-label').textContent='OFFLINE';
    setBrain('idle');
  });
}

updateDashboard();
setInterval(updateDashboard, REFRESH);
</script>
</body>
</html>
