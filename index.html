<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>NabilH ‚Äî Trading Bot</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&family=Outfit:wght@300;400;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-chart-financial/0.1.1/chartjs-chart-financial.min.js"></script>
<style>
:root{
  --bg:#0c0e14;--s:#13161f;--s2:#1c2030;--b:#252a3a;
  --t:#e2e8f0;--m:#4a5568;
  --green:#00d97e;--red:#ff4757;--blue:#3d7fff;
  --orange:#ff7c3a;--purple:#8b5cf6;
  --gbg:rgba(0,217,126,.1);--rbg:rgba(255,71,87,.1);--bbg:rgba(61,127,255,.1);
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:'Outfit',sans-serif;background:var(--bg);color:var(--t);min-height:100vh;overflow-x:hidden}

/* HEADER */
.header{background:var(--s);border-bottom:1px solid var(--b);padding:12px 20px;display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:100;backdrop-filter:blur(10px)}
.header-logo{font-weight:800;font-size:18px;color:var(--blue);letter-spacing:-.5px}
.header-sub{font-size:10px;color:var(--m);font-family:'JetBrains Mono',monospace;margin-top:1px}
.header-right{display:flex;align-items:center;gap:10px;flex-wrap:wrap;justify-content:flex-end}
.live-dot{width:8px;height:8px;border-radius:50%;background:var(--green);box-shadow:0 0 8px var(--green);animation:pulse 1.5s infinite}
@keyframes pulse{0%,100%{opacity:1;transform:scale(1)}50%{opacity:.5;transform:scale(1.3)}}
.live-label{font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace}
.latency-badge{font-size:9px;font-family:'JetBrains Mono',monospace;padding:2px 7px;border-radius:4px;border:1px solid var(--b);color:var(--m)}
.latency-good{color:var(--green);border-color:rgba(0,217,126,.3);background:var(--gbg)}
.latency-mid{color:var(--orange);border-color:rgba(255,124,58,.3);background:rgba(255,124,58,.1)}
.latency-bad{color:var(--red);border-color:rgba(255,71,87,.3);background:var(--rbg)}

/* BANNER reconnexion */
.reconnect-banner{display:none;background:rgba(255,71,87,.15);border-bottom:1px solid rgba(255,71,87,.3);padding:8px 20px;text-align:center;font-size:12px;color:var(--red);font-family:'JetBrains Mono',monospace}
.reconnect-banner.show{display:block}

/* PAGE */
.page{max-width:980px;margin:0 auto;padding:18px 16px 40px}

/* CLOCKS */
.clock-bar{display:flex;background:var(--s);border:1px solid var(--b);border-radius:12px;overflow:hidden;margin-bottom:18px}
.clock-cell{flex:1;padding:10px 12px;border-right:1px solid var(--b);display:flex;flex-direction:column;align-items:center;gap:2px}
.clock-cell:last-child{border-right:none}
.clock-flag{font-size:16px;line-height:1}
.clock-city{font-size:8px;color:var(--m);text-transform:uppercase;letter-spacing:1.5px;font-family:'JetBrains Mono',monospace}
.clock-time{font-size:15px;font-weight:700;color:var(--t);font-family:'JetBrains Mono',monospace;letter-spacing:.5px}
.ms{padding:3px 8px;border-radius:20px;font-size:9px;font-weight:700;display:flex;align-items:center;gap:4px}
.ms-open{background:var(--gbg);color:var(--green);border:1px solid rgba(0,217,126,.25)}
.ms-closed{background:var(--rbg);color:var(--red);border:1px solid rgba(255,71,87,.25)}
.ms-pre{background:rgba(255,124,58,.1);color:var(--orange);border:1px solid rgba(255,124,58,.25)}
.ms-dot{width:5px;height:5px;border-radius:50%}
.ms-dot-open{background:var(--green);animation:pulse 1.5s infinite}
.ms-dot-closed{background:var(--red)}
.ms-dot-pre{background:var(--orange);animation:pulse 2s infinite}

/* STATS */
.stats-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:18px}
.stat-card{background:var(--s);border:1px solid var(--b);border-radius:12px;padding:14px 16px;transition:border-color .2s,transform .2s}
.stat-card:hover{border-color:var(--blue);transform:translateY(-2px)}
.stat-label{font-size:9px;color:var(--m);text-transform:uppercase;letter-spacing:1px;margin-bottom:6px;font-family:'JetBrains Mono',monospace}
.stat-value{font-size:20px;font-weight:700;line-height:1}
.stat-sub{font-size:10px;color:var(--m);margin-top:3px}
.green{color:var(--green)}.red{color:var(--red)}

/* OBJECTIFS */
.obj-card{background:var(--s);border:1px solid var(--b);border-radius:12px;padding:16px;margin-bottom:10px}
.obj-title{font-size:11px;color:var(--m);font-family:'JetBrains Mono',monospace;margin-bottom:12px;display:flex;justify-content:space-between;align-items:center}
.obj-row{margin-bottom:10px}
.obj-row:last-child{margin-bottom:0}
.obj-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:4px}
.obj-label{font-size:12px;font-weight:600}
.obj-pct{font-size:11px;font-family:'JetBrains Mono',monospace;color:var(--m)}
.obj-track{height:6px;background:var(--s2);border-radius:3px;overflow:hidden}
.obj-fill{height:100%;border-radius:3px;transition:width 1s ease}
.obj-check{font-size:14px}

/* SECTION TITLE */
.stitle{font-size:10px;font-weight:700;color:var(--m);text-transform:uppercase;letter-spacing:2px;font-family:'JetBrains Mono',monospace;margin:22px 0 10px;display:flex;align-items:center;gap:8px}
.stitle::after{content:'';flex:1;height:1px;background:var(--b)}

/* CARD */
.card{background:var(--s);border:1px solid var(--b);border-radius:12px;padding:18px;margin-bottom:10px}

/* ETF GRID */
.etf-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(135px,1fr));gap:8px}
.etf-card{background:var(--s2);border:1px solid var(--b);border-radius:10px;padding:12px 14px;transition:transform .15s,border-color .2s}
.etf-card:hover{transform:translateY(-2px)}
.etf-card.sig-achat{border-color:rgba(0,217,126,.35);background:rgba(0,217,126,.05)}
.etf-card.sig-vente{border-color:rgba(255,71,87,.35);background:rgba(255,71,87,.05)}
.etf-symbol{font-size:16px;font-weight:800;font-family:'JetBrains Mono',monospace;margin-bottom:2px}
.etf-name{font-size:9px;color:var(--m);margin-bottom:8px}
.etf-price{font-size:13px;font-weight:600;font-family:'JetBrains Mono',monospace;margin-bottom:6px}
.etf-chip{display:inline-flex;align-items:center;gap:4px;padding:3px 8px;border-radius:5px;font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace}
.ec-ACHAT{background:var(--gbg);color:var(--green);border:1px solid rgba(0,217,126,.3)}
.ec-VENTE{background:var(--rbg);color:var(--red);border:1px solid rgba(255,71,87,.3)}
.ec-ATTENTE{background:rgba(255,124,58,.1);color:var(--orange);border:1px solid rgba(255,124,58,.3)}
.ec-NA{background:var(--s);color:var(--m);border:1px solid var(--b)}
.etf-conf{font-size:9px;color:var(--m);margin-top:4px;font-family:'JetBrains Mono',monospace}

/* POSITIONS */
.pos-row{display:flex;align-items:center;justify-content:space-between;padding:11px 0;border-bottom:1px solid var(--b)}
.pos-row:last-child{border:none}
.pos-symbol{font-weight:700;font-size:15px;font-family:'JetBrains Mono',monospace}
.pos-qty{font-size:11px;color:var(--m);margin-top:2px}
.pos-pnl{font-size:17px;font-weight:700;font-family:'JetBrains Mono',monospace}

/* GRAPHIQUE TABS */
.chart-tabs{display:flex;gap:6px;margin-bottom:12px;flex-wrap:wrap}
.chart-tab{padding:4px 12px;border-radius:6px;font-size:10px;font-weight:700;cursor:pointer;border:1px solid var(--b);background:transparent;color:var(--m);transition:all .2s;font-family:'JetBrains Mono',monospace}
.chart-tab.active{background:var(--bbg);border-color:rgba(61,127,255,.4);color:var(--blue)}
.chart-wrap{height:180px;position:relative}

/* CANDLESTICK CARD */
.candle-card{background:var(--s);border:1px solid var(--b);border-radius:12px;padding:18px;margin-bottom:10px}
.candle-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:14px;flex-wrap:wrap;gap:8px}
.candle-sym{font-size:16px;font-weight:800;font-family:'JetBrains Mono',monospace}
.candle-price{font-size:22px;font-weight:700;font-family:'JetBrains Mono',monospace}
.candle-change{font-size:12px;font-family:'JetBrains Mono',monospace;padding:3px 8px;border-radius:5px}
.cc-up{background:var(--gbg);color:var(--green)}
.cc-dn{background:var(--rbg);color:var(--red)}
.candle-wrap{height:200px;position:relative}
.candle-info{display:flex;gap:16px;margin-top:10px;flex-wrap:wrap}
.ci-item{font-size:10px;font-family:'JetBrains Mono',monospace}
.ci-label{color:var(--m)}
.ci-val{color:var(--t);font-weight:700}

/* DAILY */
.daily-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:8px}
.day-card{background:var(--s2);border:1px solid var(--b);border-radius:10px;padding:11px 13px;transition:transform .15s}
.day-card:hover{transform:translateY(-2px)}
.day-card.day-green{border-color:rgba(0,217,126,.3);background:rgba(0,217,126,.05)}
.day-card.day-red{border-color:rgba(255,71,87,.3);background:rgba(255,71,87,.05)}
.day-date{font-size:9px;color:var(--m);font-family:'JetBrains Mono',monospace;margin-bottom:6px}
.day-pnl{font-size:18px;font-weight:800;line-height:1}
.day-sub{font-size:10px;color:var(--m);margin-top:3px;font-family:'JetBrains Mono',monospace}
.day-bar-wrap{height:3px;background:var(--b);border-radius:2px;margin-top:7px;overflow:hidden}
.day-bar{height:100%;border-radius:2px;transition:width .5s ease}

/* BRAIN */
.ai-card{background:var(--s);border:1px solid var(--b);border-radius:12px;padding:18px;margin-bottom:10px;display:flex;align-items:flex-start;gap:18px}
.brain-wrap{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:5px}
.brain-container{position:relative;width:56px;height:56px}
.brain-svg{width:56px;height:56px}
.brain-fill{transition:fill .4s ease}
.brain-pulse{fill:none;stroke-width:1.5}
.brain-idle .brain-fill{fill:#1e2a50}
.brain-idle .brain-pulse{stroke:var(--blue);opacity:.2}
.brain-thinking .brain-fill{fill:#7a3200}
.brain-thinking .brain-pulse{stroke:var(--orange);animation:bp .6s ease-in-out infinite}
.brain-done .brain-fill{fill:#005a3c}
.brain-done .brain-pulse{stroke:var(--green);animation:bp 2s ease-in-out infinite}
@keyframes bp{0%,100%{opacity:.15;transform:scale(1)}50%{opacity:1;transform:scale(1.2)}}
.bwave{position:absolute;border-radius:50%;border:1px solid var(--orange);opacity:0}
.bw1{width:62px;height:62px;top:-3px;left:-3px;animation:wo 1s ease-out infinite}
.bw2{width:74px;height:74px;top:-9px;left:-9px;animation:wo 1s ease-out .33s infinite}
.bw3{width:86px;height:86px;top:-15px;left:-15px;animation:wo 1s ease-out .66s infinite}
@keyframes wo{0%{opacity:.6;transform:scale(.9)}100%{opacity:0;transform:scale(1.1)}}
.brain-lbl{font-size:8px;text-transform:uppercase;letter-spacing:1.5px;font-weight:700;font-family:'JetBrains Mono',monospace}
.bl-idle{color:var(--m)}.bl-thinking{color:var(--orange)}.bl-done{color:var(--green)}
.ai-content{flex:1;min-width:0}
.ai-src{font-size:9px;color:var(--m);text-transform:uppercase;letter-spacing:1px;margin-bottom:5px;font-family:'JetBrains Mono',monospace}
.ai-dec-row{display:flex;align-items:center;gap:7px;margin-bottom:8px;flex-wrap:wrap}
.dec-chip{padding:3px 10px;border-radius:5px;font-size:11px;font-weight:700;font-family:'JetBrains Mono',monospace}
.dc-ACHAT{background:var(--gbg);color:var(--green);border:1px solid rgba(0,217,126,.3)}
.dc-VENTE{background:var(--rbg);color:var(--red);border:1px solid rgba(255,71,87,.3)}
.dc-ATTENTE{background:rgba(255,124,58,.1);color:var(--orange);border:1px solid rgba(255,124,58,.3)}
.trail-chip{padding:2px 7px;border-radius:4px;font-size:9px;font-weight:700;background:rgba(139,92,246,.15);color:var(--purple);border:1px solid rgba(139,92,246,.3)}
.ai-raison{font-size:12px;color:var(--t);line-height:1.5;margin-bottom:8px}
.conf-row{display:flex;align-items:center;gap:8px;margin-bottom:6px}
.conf-label{font-size:9px;color:var(--m);white-space:nowrap;font-family:'JetBrains Mono',monospace}
.conf-track{flex:1;height:4px;background:var(--s2);border-radius:2px;overflow:hidden}
.conf-fill{height:100%;border-radius:2px;transition:width 1s ease;width:0}
.conf-pct{font-size:10px;font-weight:700;font-family:'JetBrains Mono',monospace;min-width:28px;text-align:right}
.cycle-row{display:flex;align-items:center;gap:7px}
.cycle-label{font-size:9px;color:var(--m);white-space:nowrap;font-family:'JetBrains Mono',monospace}
.cycle-track{flex:1;height:2px;background:var(--s2);border-radius:2px;overflow:hidden}
.cycle-fill{height:100%;background:var(--blue);border-radius:2px;transition:width 1s linear;width:0}
.cycle-cd{font-size:9px;color:var(--m);font-family:'JetBrains Mono',monospace;min-width:28px;text-align:right}

/* ORDERS */
.orders-list{display:flex;flex-direction:column;gap:5px}
.order-row{display:flex;align-items:center;gap:8px;background:var(--s2);border-radius:8px;padding:9px 13px;border:1px solid var(--b);flex-wrap:wrap}
.ord-buy{color:var(--green);font-weight:700;font-size:11px;font-family:'JetBrains Mono',monospace;min-width:55px}
.ord-sell{color:var(--red);font-weight:700;font-size:11px;font-family:'JetBrains Mono',monospace;min-width:55px}
.ord-sym{font-weight:700;font-size:13px;font-family:'JetBrains Mono',monospace}
.ord-qty{font-size:11px;color:var(--m);font-family:'JetBrains Mono',monospace}
.ord-price{font-size:12px;font-weight:600;font-family:'JetBrains Mono',monospace;margin-left:auto}
.ord-date{font-size:9px;color:var(--m);font-family:'JetBrains Mono',monospace}
.ord-chip{padding:2px 7px;border-radius:3px;font-size:9px;font-weight:700;font-family:'JetBrains Mono',monospace}
.oc-filled{background:var(--gbg);color:var(--green)}
.oc-partial{background:rgba(255,124,58,.1);color:var(--orange)}
.oc-pending{background:var(--bbg);color:var(--blue)}
.oc-cancel{background:var(--rbg);color:var(--red)}
@keyframes flashNew{0%,100%{background:var(--s2)}40%{background:rgba(61,127,255,.12)}}
.order-new-anim{animation:flashNew 1.5s ease 3}

.error-card{background:var(--rbg);border:1px solid rgba(255,71,87,.3);border-radius:12px;padding:28px;text-align:center;color:var(--red)}
.error-card strong{font-size:15px;display:block;margin-bottom:6px}
.error-card p{font-size:12px;color:var(--m)}
.footer{font-size:10px;color:var(--m);text-align:right;margin-top:8px;font-family:'JetBrains Mono',monospace}


/* NEWS */
.news-list{display:flex;flex-direction:column;gap:6px}
.news-item{background:var(--s2);border:1px solid var(--b);border-radius:8px;padding:10px 14px;display:flex;gap:10px;align-items:flex-start}
.news-source{font-size:9px;font-family:'JetBrains Mono',monospace;font-weight:700;color:var(--blue);min-width:70px;padding-top:1px;flex-shrink:0}
.news-title{font-size:12px;color:var(--t);line-height:1.4}
.news-count-badge{font-size:9px;font-family:'JetBrains Mono',monospace;color:var(--m);background:var(--s2);border:1px solid var(--b);border-radius:4px;padding:2px 7px;margin-left:auto}
/* RESPONSIVE */
@media(max-width:600px){
  .stats-grid{grid-template-columns:repeat(2,1fr)}
  .stat-value{font-size:17px}
  .clock-time{font-size:13px}
  .ai-card{flex-direction:column;gap:12px}
  .brain-wrap{flex-direction:row;gap:10px;align-items:center}
  .etf-grid{grid-template-columns:repeat(auto-fill,minmax(120px,1fr))}
  .ord-price{margin-left:0}
  .header-sub{display:none}
  .candle-price{font-size:18px}
}
@media(max-width:380px){
  .stats-grid{grid-template-columns:1fr 1fr}
  .clock-cell{padding:8px 6px}
  .clock-time{font-size:12px}
}
</style>
</head>
<body>

<!-- Banner reconnexion -->
<div class="reconnect-banner" id="reconnect-banner">
  ‚ö° Connexion perdue ‚Äî tentative de reconnexion automatique...
</div>

<header class="header">
  <div>
    <div class="header-logo">NabilH</div>
    <div class="header-sub">Multi-ETF ¬∑ SPY VGK EWU EEM EWJ EWG EWQ</div>
  </div>
  <div class="header-right">
    <span class="latency-badge" id="latency-badge">‚Äî ms</span>
    <div class="live-dot" id="live-dot"></div>
    <span class="live-label green" id="live-label">LIVE</span>
  </div>
</header>

<div class="page">

  <!-- HORLOGES -->
  <div class="clock-bar">
    <div class="clock-cell"><div class="clock-flag">üá´üá∑</div><div class="clock-city">Paris</div><div class="clock-time" id="clock-paris">--:--:--</div></div>
    <div class="clock-cell"><div class="clock-flag">üá∫üá∏</div><div class="clock-city">New York</div><div class="clock-time" id="clock-ny">--:--:--</div></div>
    <div class="clock-cell"><div class="clock-city">NYSE</div><div id="market-badge" style="margin-top:4px"></div></div>
  </div>

  <!-- STATS -->
  <div class="stats-grid">
    <div class="stat-card"><div class="stat-label">Portefeuille</div><div class="stat-value" id="s-equity">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">Cash</div><div class="stat-value" id="s-cash">‚Äî</div></div>
    <div class="stat-card"><div class="stat-label">Perf. Jour</div><div class="stat-value" id="s-pnl">‚Äî</div><div class="stat-sub" id="s-status">‚Äî</div></div>
  </div>

  <!-- OBJECTIFS -->
  <div class="stitle">üéØ Objectifs de performance</div>
  <div class="obj-card" id="obj-card">
    <div class="obj-title"><span>Capital de r√©f√©rence : 500‚Ç¨</span><span id="obj-current-val" style="color:var(--t);font-weight:700">‚Äî</span></div>
    <div id="obj-rows"></div>
  </div>

  <!-- CANDLESTICK SPY -->
  <div class="stitle">üìä SPY ‚Äî Graphique temps r√©el</div>
  <div class="candle-card">
    <div class="candle-header">
      <div>
        <div class="candle-sym">SPY üá∫üá∏</div>
        <div style="font-size:10px;color:var(--m);font-family:'JetBrains Mono',monospace">S&P 500 ETF ¬∑ Donn√©es horaires</div>
      </div>
      <div style="text-align:right">
        <div class="candle-price" id="candle-price">‚Äî</div>
        <div class="candle-change" id="candle-change">‚Äî</div>
      </div>
    </div>
    <div class="candle-wrap"><canvas id="candleChart"></canvas></div>
    <div class="candle-info" id="candle-info"></div>
  </div>

  <!-- ETF SIGNALS -->
  <div class="stitle">üåç Signaux par ETF</div>
  <div id="etf-grid-section"><div class="card"><p style="color:var(--m);font-size:13px">Chargement...</p></div></div>

  <!-- POSITIONS -->
  <div class="stitle">üìà Positions ouvertes</div>
  <div class="card" id="positions-card"><p style="color:var(--m);font-size:13px">Chargement...</p></div>

  <!-- GRAPHIQUE INTRADAY -->
  <div class="stitle">üìâ Performance intraday</div>
  <div class="card" id="chart-card"><div style="height:150px;display:flex;align-items:center;justify-content:center;color:var(--m);font-size:13px">Donn√©es en cours...</div></div>

  <!-- JOURNALIER -->
  <div class="stitle">üìÖ Historique journalier</div>
  <div id="daily-section"><div class="card"><p style="color:var(--m);font-size:13px">Chargement...</p></div></div>

  <!-- IA -->
  <div class="stitle">ü§ñ Analyse IA ‚Äî SPY</div>
  <div class="ai-card" id="ai-card">
    <div class="brain-wrap">
      <div class="brain-container" id="brain-container"><div class="brain-idle" id="brain-inner"></div></div>
      <div class="brain-lbl bl-idle" id="brain-lbl">En veille</div>
    </div>
    <div class="ai-content" id="ai-content"><div class="ai-src">Initialisation...</div></div>
  </div>

  <!-- ACTUALIT√âS -->
  <div class="stitle">üì∞ Actualit√©s <span id="news-count-badge" class="news-count-badge">‚Äî sources</span></div>
  <div id="news-section"><div class="card"><p style="color:var(--m);font-size:13px">Chargement...</p></div></div>

  <!-- ORDRES -->
  <div class="stitle">üìã Ordres r√©cents</div>
  <div id="orders-section"><div class="card"><p style="color:var(--m);font-size:13px">Chargement...</p></div></div>

  <div class="footer" id="refresh-time">‚Äî</div>
</div>

<script>
const DATA_URL  = 'https://incorporated-wit-accessibility-forever.trycloudflare.com/api/state';
const REFRESH   = 30000;
const BOT_CYCLE = 300;
const CAPITAL_REF = 500; // Capital de r√©f√©rence pour les objectifs

const OBJECTIFS = [
  { label:'+5%',  target: CAPITAL_REF * 1.05,  color:'#3d7fff' },
  { label:'+10%', target: CAPITAL_REF * 1.10,  color:'#00d97e' },
  { label:'+20%', target: CAPITAL_REF * 1.20,  color:'#ff7c3a' },
  { label:'+50%', target: CAPITAL_REF * 1.50,  color:'#8b5cf6' },
  { label:'√ó2',   target: CAPITAL_REF * 2.00,  color:'#ff4757' },
];

let chartInstance   = null;
let candleInstance  = null;
let currentMode     = 'value';
let cycleTimer      = null;
let lastOrderIds    = [];
let failCount       = 0;
let retryTimer      = null;

const ETF_NAMES = {SPY:'S&P 500',VGK:'Europe',EWU:'UK',EEM:'√âmergents',EWJ:'Japon',EWG:'Allemagne',EWQ:'France'};
const ETF_FLAGS = {SPY:'üá∫üá∏',VGK:'üá™üá∫',EWU:'üá¨üáß',EEM:'üåç',EWJ:'üáØüáµ',EWG:'üá©üá™',EWQ:'üá´üá∑'};

// ‚îÄ‚îÄ Horloges ‚îÄ‚îÄ
function updateClocks(){
  const now=new Date();
  document.getElementById('clock-paris').textContent=now.toLocaleTimeString('fr-FR',{timeZone:'Europe/Paris',hour12:false});
  document.getElementById('clock-ny').textContent=now.toLocaleTimeString('fr-FR',{timeZone:'America/New_York',hour12:false});
  const ny=new Date(now.toLocaleString('en-US',{timeZone:'America/New_York'}));
  const t=ny.getHours()*60+ny.getMinutes(),day=ny.getDay();
  const el=document.getElementById('market-badge');
  if(day===0||day===6) el.innerHTML=`<div class="ms ms-closed"><div class="ms-dot ms-dot-closed"></div>Weekend</div>`;
  else if(t>=570&&t<960) el.innerHTML=`<div class="ms ms-open"><div class="ms-dot ms-dot-open"></div>Ouvert</div>`;
  else if((t>=240&&t<570)||(t>=960&&t<1200)) el.innerHTML=`<div class="ms ms-pre"><div class="ms-dot ms-dot-pre"></div>Pr√©/Post</div>`;
  else el.innerHTML=`<div class="ms ms-closed"><div class="ms-dot ms-dot-closed"></div>Ferm√©</div>`;
}
setInterval(updateClocks,1000); updateClocks();

// ‚îÄ‚îÄ Latence ‚îÄ‚îÄ
function setLatency(ms){
  const el=document.getElementById('latency-badge');
  if(!el)return;
  el.textContent=ms+'ms';
  el.className='latency-badge '+(ms<300?'latency-good':ms<800?'latency-mid':'latency-bad');
}

// ‚îÄ‚îÄ Brain ‚îÄ‚îÄ
function brainSVG(){
  return `<svg class="brain-svg" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
    <path class="brain-fill" d="M50,20 C35,18 18,25 15,40 C12,52 16,60 22,66 C26,70 30,72 30,78 C30,82 34,85 38,85 L50,85 L50,20 Z"/>
    <path class="brain-fill" d="M50,20 C65,18 82,25 85,40 C88,52 84,60 78,66 C74,70 70,72 70,78 C70,82 66,85 62,85 L50,85 L50,20 Z"/>
    <line x1="50" y1="22" x2="50" y2="83" stroke="#0c0e14" stroke-width="2.5"/>
    <path class="brain-pulse" d="M28,38 Q22,44 26,52"/><path class="brain-pulse" d="M22,52 Q20,60 26,64"/>
    <path class="brain-pulse" d="M32,28 Q26,34 30,42"/><path class="brain-pulse" d="M72,38 Q78,44 74,52"/>
    <path class="brain-pulse" d="M78,52 Q80,60 74,64"/><path class="brain-pulse" d="M68,28 Q74,34 70,42"/>
    <rect class="brain-fill" x="44" y="83" width="12" height="8" rx="3"/>
  </svg>`;
}
function setBrain(state){
  const c=document.getElementById('brain-container'),l=document.getElementById('brain-lbl');
  if(!c||!l)return;
  const waves=state==='thinking'?'<div class="bwave bw1"></div><div class="bwave bw2"></div><div class="bwave bw3"></div>':'';
  c.innerHTML=`${waves}<div class="brain-${state}">${brainSVG()}</div>`;
  l.textContent={idle:'En veille',thinking:'Analyse...',done:'D√©cision'}[state]||'';
  l.className=`brain-lbl bl-${state}`;
}

// ‚îÄ‚îÄ Objectifs ‚îÄ‚îÄ
function buildObjectifs(equity){
  const val = equity || CAPITAL_REF;
  document.getElementById('obj-current-val').textContent = val.toFixed(2)+'‚Ç¨';
  const pct = ((val - CAPITAL_REF) / CAPITAL_REF) * 100;
  let html='';
  OBJECTIFS.forEach(obj=>{
    const progress = Math.min((val / obj.target) * 100, 100);
    const reached  = val >= obj.target;
    html+=`<div class="obj-row">
      <div class="obj-header">
        <span class="obj-label" style="color:${reached?obj.color:''}">${obj.label} ${reached?'‚úÖ':''}</span>
        <span class="obj-pct">${val.toFixed(0)}‚Ç¨ / ${obj.target.toFixed(0)}‚Ç¨ ¬∑ ${progress.toFixed(1)}%</span>
      </div>
      <div class="obj-track">
        <div class="obj-fill" style="width:${progress}%;background:${obj.color}${reached?'':'88'}"></div>
      </div>
    </div>`;
  });
  document.getElementById('obj-rows').innerHTML=html;
}

// ‚îÄ‚îÄ Candlestick SPY (simul√© depuis history) ‚îÄ‚îÄ
function buildCandleChart(history, spyAnalysis){
  if(!history||history.length<4){
    document.getElementById('candle-price').textContent='‚Äî';
    document.getElementById('candle-change').textContent='‚Äî';
    document.getElementById('candle-info').innerHTML='';
    return;
  }

  const price = spyAnalysis && spyAnalysis.price ? spyAnalysis.price : null;
  const rsi   = spyAnalysis && spyAnalysis.rsi   ? spyAnalysis.rsi   : null;

  if(price){
    const first = history[0].v;
    const chg   = price - first;
    const chgPct= (chg/first*100).toFixed(2);
    const isUp  = chg >= 0;
    document.getElementById('candle-price').textContent = price.toFixed(2)+'$';
    document.getElementById('candle-price').style.color = isUp ? 'var(--green)' : 'var(--red)';
    const chgEl = document.getElementById('candle-change');
    chgEl.textContent = `${isUp?'+':''}${chg.toFixed(2)}$ (${isUp?'+':''}${chgPct}%)`;
    chgEl.className = `candle-change ${isUp?'cc-up':'cc-dn'}`;
  }

  // Infos RSI/EMA
  let infoHtml='';
  if(rsi) infoHtml+=`<div class="ci-item"><span class="ci-label">RSI </span><span class="ci-val" style="color:${rsi>70?'var(--red)':rsi<40?'var(--blue)':'var(--t)'}">${rsi}</span></div>`;
  if(spyAnalysis&&spyAnalysis.decision) infoHtml+=`<div class="ci-item"><span class="ci-label">Signal </span><span class="ci-val">${spyAnalysis.decision}</span></div>`;
  document.getElementById('candle-info').innerHTML=infoHtml;

  // Graphique ligne SPY (fallback candlestick si pas de donn√©es OHLC)
  const ctx=document.getElementById('candleChart');
  if(!ctx)return;
  const vals=history.map(h=>h.v);
  const isPos=vals[vals.length-1]>=vals[0];
  const col=isPos?'#00d97e':'#ff4757';
  if(candleInstance){candleInstance.destroy();candleInstance=null;}
  candleInstance=new Chart(ctx,{
    type:'line',
    data:{
      labels:history.map(h=>h.t),
      datasets:[{
        data:vals,
        borderColor:col,
        backgroundColor:isPos?'rgba(0,217,126,.08)':'rgba(255,71,87,.08)',
        borderWidth:2,
        pointRadius:0,
        pointHoverRadius:5,
        fill:true,
        tension:.3
      }]
    },
    options:{
      responsive:true,maintainAspectRatio:false,
      plugins:{
        legend:{display:false},
        tooltip:{
          mode:'index',intersect:false,
          callbacks:{label:c=>c.parsed.y.toFixed(2)+'‚Ç¨'},
          backgroundColor:'#13161f',borderColor:'#252a3a',borderWidth:1,
          titleColor:'#4a5568',bodyColor:'#e2e8f0',padding:10
        }
      },
      scales:{
        x:{grid:{color:'rgba(37,42,58,.7)'},ticks:{color:'#4a5568',maxTicksLimit:8,font:{size:9,family:'JetBrains Mono'}}},
        y:{grid:{color:'rgba(37,42,58,.7)'},ticks:{color:'#4a5568',font:{size:9,family:'JetBrains Mono'},callback:v=>v.toFixed(0)+'‚Ç¨'},position:'right'}
      }
    }
  });
}

// ‚îÄ‚îÄ ETF Grid ‚îÄ‚îÄ
function buildEtfGrid(sa){
  if(!sa||!Object.keys(sa).length)
    return `<div class="card"><p style="color:var(--m);font-size:13px">Pas encore de donn√©es ‚Äî attendez le prochain cycle.</p></div>`;
  const symbols=['SPY','VGK','EWU','EEM','EWJ','EWG','EWQ'];
  let html=`<div class="etf-grid">`;
  symbols.forEach(sym=>{
    const a=sa[sym];
    if(!a){html+=`<div class="etf-card"><div class="etf-symbol">${sym}</div><div class="etf-name">${ETF_FLAGS[sym]||''} ${ETF_NAMES[sym]||''}</div><div class="etf-chip ec-NA">N/A</div></div>`;return;}
    const dec=a.decision||'ATTENTE';
    html+=`<div class="etf-card sig-${dec.toLowerCase()}">
      <div class="etf-symbol">${sym}</div>
      <div class="etf-name">${ETF_FLAGS[sym]||''} ${ETF_NAMES[sym]||''}</div>
      ${a.price?`<div class="etf-price">${a.price.toFixed(2)}$</div>`:''}
      <div class="etf-chip ec-${dec}">${dec}</div>
      ${a.confiance!=null?`<div class="etf-conf">Conf. ${a.confiance}% ¬∑ RSI ${a.rsi||'‚Äî'}</div>`:''}
      ${a.trailing_stop?`<div style="margin-top:4px;font-size:9px;color:var(--purple)">üõ° Trailing</div>`:''}
    </div>`;
  });
  return html+`</div>`;
}

// ‚îÄ‚îÄ Chart intraday ‚îÄ‚îÄ
function buildChartHtml(history){
  if(!history||history.length<2)
    return `<div style="height:150px;display:flex;align-items:center;justify-content:center;color:var(--m);font-size:13px">Donn√©es en cours d'accumulation...</div>`;
  return `<div class="chart-tabs">
    <button class="chart-tab ${currentMode==='value'?'active':''}" onclick="switchChart(event,'value')">Valeur ‚Ç¨</button>
    <button class="chart-tab ${currentMode==='pnl'?'active':''}" onclick="switchChart(event,'pnl')">Perf. %</button>
  </div><div class="chart-wrap"><canvas id="perfChart"></canvas></div>`;
}
function renderChart(history){
  if(!history||history.length<2)return;
  const ctx=document.getElementById('perfChart');if(!ctx)return;
  const vals=currentMode==='value'?history.map(h=>h.v):history.map(h=>h.pnl);
  const isPos=vals[vals.length-1]>=vals[0];
  const col=isPos?'#00d97e':'#ff4757';
  if(chartInstance){chartInstance.destroy();chartInstance=null;}
  chartInstance=new Chart(ctx,{type:'line',
    data:{labels:history.map(h=>h.t),datasets:[{data:vals,borderColor:col,backgroundColor:isPos?'rgba(0,217,126,.07)':'rgba(255,71,87,.07)',borderWidth:2,pointRadius:0,pointHoverRadius:4,fill:true,tension:.3}]},
    options:{responsive:true,maintainAspectRatio:false,
      plugins:{legend:{display:false},tooltip:{mode:'index',intersect:false,callbacks:{label:c=>currentMode==='value'?c.parsed.y.toFixed(2)+' ‚Ç¨':(c.parsed.y>=0?'+':'')+c.parsed.y.toFixed(4)+' %'},backgroundColor:'#13161f',borderColor:'#252a3a',borderWidth:1,titleColor:'#4a5568',bodyColor:'#e2e8f0',padding:10}},
      scales:{x:{grid:{color:'rgba(37,42,58,.7)'},ticks:{color:'#4a5568',maxTicksLimit:6,font:{size:9,family:'JetBrains Mono'}}},y:{grid:{color:'rgba(37,42,58,.7)'},ticks:{color:'#4a5568',font:{size:9,family:'JetBrains Mono'},callback:v=>currentMode==='value'?v.toFixed(0)+'‚Ç¨':v.toFixed(2)+'%'},position:'right'}}}
  });
}
window.switchChart=function(e,mode){
  currentMode=mode;
  document.querySelectorAll('.chart-tab').forEach(t=>t.classList.remove('active'));
  e.target.classList.add('active');
  if(window._lastHistory)renderChart(window._lastHistory);
};

// ‚îÄ‚îÄ Daily ‚îÄ‚îÄ
function buildDaily(daily){
  if(!daily||!daily.length)
    return `<div class="card"><p style="color:var(--m);font-size:13px;padding:4px 0">Les donn√©es journali√®res appara√Ætront apr√®s la premi√®re journ√©e.</p></div>`;
  const sorted=[...daily].reverse();
  const maxAbs=Math.max(...daily.map(d=>Math.abs(d.pnl||0)),.01);
  let html=`<div class="daily-grid">`;
  sorted.forEach(d=>{
    const pnl=d.pnl||0,pct=d.pnl_pct||0;
    const isPos=pnl>0,isZero=Math.abs(pnl)<.01;
    const cls=isZero?'':isPos?'day-green':'day-red';
    const pcls=isZero?'':isPos?'green':'red';
    const barPct=Math.round(Math.abs(pnl)/maxAbs*100);
    const date=d.date?d.date.split('-').slice(1).reverse().join('/'):'‚Äî';
    html+=`<div class="day-card ${cls}">
      <div class="day-date">${date}</div>
      <div class="day-pnl ${pcls}">${pnl>=0?'+':''}${pnl.toFixed(2)}‚Ç¨</div>
      <div class="day-sub">${pct>=0?'+':''}${pct.toFixed(3)}%</div>
      <div class="day-bar-wrap"><div class="day-bar ${pcls}" style="width:${barPct}%"></div></div>
    </div>`;
  });
  return html+`</div>`;
}

// ‚îÄ‚îÄ IA ‚îÄ‚îÄ
function updateAiBlock(ai,thinking){
  const state=thinking?'thinking':(ai&&ai.decision?'done':'idle');
  const isGemini=ai&&ai.source&&ai.source.toLowerCase().includes('gemini');
  const src=isGemini?'Gemini 1.5 Flash':'Logique classique';
  const bc=(ai&&(ai.confiance||0))>=70?'#00d97e':(ai&&(ai.confiance||0))>=50?'#ff7c3a':'#ff4757';
  const conf=ai?(ai.confiance||0):0;
  const dec=ai?(ai.decision||'ATTENTE'):'ATTENTE';
  const raison=ai?(ai.raison||'...'):'...';
  setBrain(state);
  document.getElementById('ai-content').innerHTML=`
    <div class="ai-src">${src} ‚Äî SPY</div>
    <div class="ai-dec-row">
      <div class="dec-chip dc-${dec}">${dec}</div>
      ${ai&&ai.trailing_stop?'<div class="trail-chip">üõ° Trailing</div>':''}
    </div>
    <div class="ai-raison">${raison}</div>
    <div class="conf-row">
      <span class="conf-label">Confiance</span>
      <div class="conf-track"><div class="conf-fill" id="conf-fill" style="width:0%;background:${bc}"></div></div>
      <span class="conf-pct" style="color:${bc}">${conf}%</span>
    </div>
    <div class="cycle-row">
      <span class="cycle-label">Prochain cycle</span>
      <div class="cycle-track"><div class="cycle-fill" id="cycle-fill" style="width:0%"></div></div>
      <span class="cycle-cd" id="cycle-cd">5:00</span>
    </div>`;
  setTimeout(()=>{const f=document.getElementById('conf-fill');if(f)f.style.width=conf+'%';},200);
}


// ‚îÄ‚îÄ News ‚îÄ‚îÄ
function buildNews(news){
  if(!news||!news.length)
    return `<div class="card"><p style="color:var(--m);font-size:13px">Actualit√©s en cours de r√©cup√©ration... (premier cycle)</p></div>`;
  const sources={Yahoo:'#3d7fff',Reuters:'#ff7c3a',AP:'#00d97e','Seeking Alpha':'#8b5cf6'};
  let html=`<div class="news-list">`;
  news.forEach(n=>{
    const match=n.match(/\[([^\]]+)\]\s*(.*)/);
    if(!match)return;
    const src=match[1], title=match[2];
    const col=Object.entries(sources).find(([k])=>src.includes(k))?.[1]||'var(--m)';
    html+=`<div class="news-item">
      <span class="news-source" style="color:${col}">${src}</span>
      <span class="news-title">${title}</span>
    </div>`;
  });
  return html+`</div>`;
}

// ‚îÄ‚îÄ Orders ‚îÄ‚îÄ
function buildOrders(orders){
  if(!orders||!orders.length)
    return `<div class="card"><p style="color:var(--m);font-size:13px">Aucun ordre r√©cent.</p></div>`;
  const chips={filled:['oc-filled','Ex√©cut√©'],partially_filled:['oc-partial','Partiel'],new:['oc-pending','Attente'],accepted:['oc-pending','Attente'],canceled:['oc-cancel','Annul√©'],rejected:['oc-cancel','Rejet√©']};
  let html=`<div class="orders-list">`;
  orders.forEach((o,i)=>{
    const isNew=!lastOrderIds.includes(o.id)&&i===0;
    const[chipCls,chipLbl]=chips[o.status]||['oc-pending',o.status];
    const isBuy=o.side==='buy';
    html+=`<div class="order-row ${isNew?'order-new-anim':''}">
      <div class="${isBuy?'ord-buy':'ord-sell'}">${isBuy?'‚ñ≤ BUY':'‚ñº SELL'}</div>
      <div class="ord-sym">${o.symbol}</div>
      <div class="ord-qty">${o.filled_qty}/${o.qty}</div>
      <span class="ord-chip ${chipCls}">${chipLbl}</span>
      <div class="ord-price">${o.filled_price?o.filled_price.toFixed(2)+'$':'‚Äî'}</div>
      <div class="ord-date">${o.created_at}</div>
    </div>`;
  });
  html+=`</div>`;
  lastOrderIds=orders.map(o=>o.id);
  return html;
}

// ‚îÄ‚îÄ Countdown ‚îÄ‚îÄ
function startCycle(){
  clearInterval(cycleTimer);
  let s=0;
  cycleTimer=setInterval(()=>{
    s++;
    const rem=BOT_CYCLE-(s%BOT_CYCLE),pct=((s%BOT_CYCLE)/BOT_CYCLE)*100;
    const f=document.getElementById('cycle-fill'),c=document.getElementById('cycle-cd');
    if(f)f.style.width=pct+'%';
    if(c)c.textContent=`${Math.floor(rem/60)}:${(rem%60).toString().padStart(2,'0')}`;
  },1000);
}

// ‚îÄ‚îÄ Reconnexion auto ‚îÄ‚îÄ
function scheduleRetry(delay){
  clearTimeout(retryTimer);
  retryTimer=setTimeout(()=>updateDashboard(),delay);
}

// ‚îÄ‚îÄ Update principal ‚îÄ‚îÄ
function updateDashboard(){
  setBrain('thinking');
  const lbl=document.getElementById('live-label');
  const dot=document.getElementById('live-dot');
  lbl.textContent='SYNC'; lbl.className='live-label';

  const t0=Date.now();

  fetch(DATA_URL)
  .then(r=>{if(!r.ok)throw new Error('HTTP '+r.status);return r.json();})
  .then(data=>{
    const latency=Date.now()-t0;
    setLatency(latency);
    failCount=0;
    document.getElementById('reconnect-banner').classList.remove('show');
    dot.style.background='var(--green)';
    lbl.textContent='LIVE'; lbl.className='live-label green';

    const ai=data.ai_analysis||{},pos=data.positions||[],pnl=data.daily_pnl||0;
    const sa=data.symbols_analysis||{};

    // Stats
    const equity=data.portfolio_value||0;
    document.getElementById('s-equity').textContent=equity.toFixed(2)+' ‚Ç¨';
    document.getElementById('s-cash').textContent=(data.cash||0).toFixed(2)+' ‚Ç¨';
    const pe=document.getElementById('s-pnl');
    pe.textContent=(pnl>=0?'+':'')+pnl.toFixed(3)+' %';
    pe.className='stat-value '+(pnl>=0?'green':'red');
    document.getElementById('s-status').textContent=data.status||'‚Äî';

    // Objectifs
    buildObjectifs(equity);

    // Candlestick SPY
    window._lastHistory=data.history||[];
    buildCandleChart(window._lastHistory, sa['SPY']);

    // ETF Grid
    document.getElementById('etf-grid-section').innerHTML=buildEtfGrid(sa);

    // Positions
    let posHtml=`<p style="color:var(--m);font-size:13px;padding:4px 0">Aucune position ouverte.</p>`;
    if(pos.length){
      posHtml='';
      pos.forEach(p=>{
        const isP=p.pnl>=0;
        posHtml+=`<div class="pos-row">
          <div><div class="pos-symbol">${ETF_FLAGS[p.symbol]||''} ${p.symbol}</div><div class="pos-qty">${p.qty} actions ¬∑ ${ETF_NAMES[p.symbol]||''}</div></div>
          <div class="pos-pnl ${isP?'green':'red'}">${isP?'+':''}${p.pnl.toFixed(2)}%</div>
        </div>`;
      });
    }
    document.getElementById('positions-card').innerHTML=posHtml;

    // Chart intraday
    document.getElementById('chart-card').innerHTML=buildChartHtml(window._lastHistory);
    setTimeout(()=>renderChart(window._lastHistory),50);

    // Daily
    document.getElementById('daily-section').innerHTML=buildDaily(data.daily_history||[]);

    // IA
    updateAiBlock(ai,false);

    // Orders
    document.getElementById('orders-section').innerHTML=buildOrders(data.orders||[]);

    // News
    const latestNews=data.latest_news||[];
    document.getElementById('news-section').innerHTML=buildNews(latestNews);
    const nb=document.getElementById('news-count-badge');
    if(nb)nb.textContent=latestNews.length+' titres';

    // Badge news count sur IA
    const aiSrc=document.querySelector('.ai-src');
    if(aiSrc&&data.ai_analysis&&data.ai_analysis.news_count!=null){
      const nc=data.ai_analysis.news_count;
      if(!aiSrc.querySelector('.nc-badge')){
        const badge=document.createElement('span');
        badge.className='news-count-badge nc-badge';
        badge.textContent=nc+' news';
        aiSrc.appendChild(badge);
      }
    }

    startCycle();
    document.getElementById('refresh-time').textContent=`Mise √† jour : ${new Date().toLocaleTimeString()} ¬∑ ${latency}ms`;
  })
  .catch(err=>{
    failCount++;
    dot.style.background='var(--red)';
    lbl.textContent='OFFLINE'; lbl.className='live-label red';
    setBrain('idle');
    setLatency(9999);

    // Banner reconnexion
    document.getElementById('reconnect-banner').classList.add('show');

    // Retry exponentiel : 5s, 10s, 30s, 60s, 60s...
    const delays=[5000,10000,30000,60000];
    const delay=delays[Math.min(failCount-1,delays.length-1)];
    document.getElementById('reconnect-banner').textContent=
      `‚ö° Connexion perdue (${err.message}) ‚Äî reconnexion dans ${delay/1000}s...`;
    scheduleRetry(delay);

    document.getElementById('refresh-time').textContent=`Derni√®re tentative : ${new Date().toLocaleTimeString()} ¬∑ Erreur`;
  });
}

updateDashboard();
setInterval(updateDashboard, REFRESH);
</script>
</body>
</html>
